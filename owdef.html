<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìš´ë¹¨ì›¹ì¡´ë§ê²œ: REBORN</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Pretendard', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { background: #1a1a1a; border: 2px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: crosshair; }
        #ui-overlay { position: absolute; pointer-events: none; width: 600px; height: 800px; }
        .menu-screen { position: absolute; top: 0; left: 0; width: 600px; height: 800px; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; }
        h1 { font-size: 48px; color: #f1c40f; text-shadow: 0 0 10px #f1c40f; margin-bottom: 50px; }
        .btn { padding: 15px 40px; font-size: 20px; background: #e74c3c; border: none; color: white; border-radius: 30px; cursor: pointer; margin: 10px; transition: 0.2s; }
        .btn:hover { transform: scale(1.1); background: #ff5e4d; }
        .stage-btn { background: #3498db; width: 200px; }
        #in-game-ui { position: absolute; top: 20px; left: 20px; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="600" height="800"></canvas>

    <div id="ui-overlay">
        <div id="start-screen" class="menu-screen">
            <h1>ìš´ë¹¨ì›¹ì¡´ë§ê²œ</h1>
            <button class="btn" onclick="showStageSelect()">ê²Œì„ ì‹œì‘</button>
            <button class="btn" style="background:#555">ì„¤ì •</button>
        </div>

        <div id="stage-screen" class="menu-screen hidden">
            <h1 style="font-size:32px">ìŠ¤í…Œì´ì§€ ì„ íƒ</h1>
            <button class="btn stage-btn" onclick="startGame(1)">Stage 1 (Normal)</button>
            <button class="btn stage-btn" style="background:#8e44ad" onclick="startGame(2)">Stage 2 (Hard)</button>
            <button class="btn" style="background:#555" onclick="showStart()">ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div id="in-game-ui">
            <div style="font-size:24px; color:#f1c40f">ğŸ’° <span id="gold-text">100</span></div>
            <div style="font-size:20px;">ğŸŒŠ Wave: <span id="wave-text">1</span></div>
            <div style="font-size:18px; color:#ff4d4d">ğŸ‘¾ Mobs: <span id="mob-text">0</span>/50</div>
        </div>
    </div>

<script>
/** ğŸ› ï¸ ì—”ì§€ë‹ˆì–´: ì—”ì§„ í•µì‹¬ ì„¤ì • **/
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameState = 'START'; // START, STAGE, PLAY, GAMEOVER
let gold = 100;
let wave = 1;
let lastSpawnTime = 0;
let lastWaveTime = 0;

// ìœ ë‹› ë°ì´í„° (ê¸°íšì ì„¤ê³„)
const UNIT_DATA = {
    'ê²€ì‚¬': { color: '#ecf0f1', ability: 'ìŠ¤í„´', chance: 0.2, speed: 30 },
    'ê¶ìˆ˜': { color: '#3498db', ability: 'ì—°ì‚¬', speed: 10 },
    'ë§ˆë²•ì‚¬': { color: '#9b59b6', ability: 'ê´‘ì—­', range: 80, speed: 50 },
    'ë„ì ': { color: '#f1c40f', ability: 'ì•½íƒˆ', chance: 0.3, speed: 40 }
};

let units = [];
let monsters = [];
let particles = [];
let board = Array(16).fill(null);

/** ğŸ¨ ë””ìì´ë„ˆ: ì‹œê° íš¨ê³¼ í´ë˜ìŠ¤ **/
class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.size = Math.random() * 5 + 2;
        this.vx = (Math.random() - 0.5) * 10;
        this.vy = (Math.random() - 0.5) * 10;
        this.life = 1.0;
    }
    draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
        ctx.fill();
        this.life -= 0.03;
    }
}

/** ğŸ‘¨â€ğŸ’» í”„ë¡œê·¸ë˜ë¨¸: í•µì‹¬ ë¡œì§ êµ¬í˜„ **/
function showStageSelect() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('stage-screen').classList.remove('hidden');
}

function showStart() {
    document.getElementById('stage-screen').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
}

function startGame(stage) {
    gameState = 'PLAY';
    document.getElementById('stage-screen').classList.add('hidden');
    document.getElementById('in-game-ui').style.display = 'block';
    gold = 100;
    wave = 1;
    units = [];
    monsters = [];
    spawnUnit(); // ì´ˆê¸° ìœ ë‹›
}

function spawnUnit() {
    const emptySlots = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
    if (emptySlots.length > 0 && gold >= 10) {
        gold -= 10;
        const idx = emptySlots[Math.floor(Math.random() * emptySlots.length)];
        const types = Object.keys(UNIT_DATA);
        const name = types[Math.floor(Math.random() * types.length)];
        const grade = 1;
        
        const x = (idx % 4) * 120 + 120;
        const y = Math.floor(idx / 4) * 120 + 400;
        
        board[idx] = { name, grade, x, y, lastAttack: 0, ...UNIT_DATA[name] };
        createExplosion(x, y, '#fff');
    }
}

function createExplosion(x, y, color) {
    for(let i=0; i<15; i++) particles.push(new Particle(x, y, color));
}

canvas.addEventListener('mousedown', (e) => {
    if (gameState !== 'PLAY') return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    // ì†Œí™˜ ë²„íŠ¼ ì˜ì—­ í´ë¦­ (í•˜ë‹¨ ì„ì˜ ì§€ì •)
    if (my > 700) { spawnUnit(); return; }

    // í•©ì„± ë¡œì§: ê°„ë‹¨íˆ ê°™ì€ ìœ ë‹› í´ë¦­ ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ (í”„ë¡œí† íƒ€ì…ìš©)
    board.forEach((u, i) => {
        if (u && Math.hypot(u.x - mx, u.y - my) < 40) {
            // ì—¬ê¸°ì— ì‹¤ì œ ë“œë˜ê·¸ í•©ì„± ë¡œì§ì„ í™•ì¥ ê°€ëŠ¥
            createExplosion(u.x, u.y, u.color);
        }
    });
});

/** ğŸ› ï¸ ì—”ì§„: ë Œë”ë§ ë£¨í”„ **/
function update(time) {
    ctx.clearRect(0, 0, 600, 800);

    if (gameState === 'PLAY') {
        // 1. ëª¬ìŠ¤í„° ìŠ¤í°
        if (time - lastSpawnTime > 2000 / (1 + wave * 0.1)) {
            monsters.push({ x: 0, y: 50, hp: 10 * wave, maxHp: 10 * wave, speed: 1 + wave*0.1 });
            lastSpawnTime = time;
        }

        // 2. ëª¬ìŠ¤í„° ì´ë™ (ã„·ì ê²½ë¡œ)
        monsters.forEach((m, i) => {
            if (m.x < 550 && m.y === 50) m.x += m.speed;
            else if (m.x >= 550 && m.y < 200) m.y += m.speed;
            else if (m.y >= 200 && m.x > 50) m.x -= m.speed;
            
            ctx.fillStyle = '#ff4d4d';
            ctx.fillRect(m.x-15, m.y-15, 30, 30);
            // ì²´ë ¥ë°”
            ctx.fillStyle = '#000'; ctx.fillRect(m.x-15, m.y-25, 30, 5);
            ctx.fillStyle = '#0f0'; ctx.fillRect(m.x-15, m.y-25, (m.hp/m.maxHp)*30, 5);
        });

        // 3. ìœ ë‹› ê³µê²© ë° íŠ¹ìˆ˜ëŠ¥ë ¥ (ì• ë‹ˆë©”ì´ì…˜ ì´í™íŠ¸)
        board.forEach(u => {
            if (!u) return;
            // ìœ ë‹› ê·¸ë¦¬ê¸°
            ctx.shadowBlur = 10; ctx.shadowColor = u.color;
            ctx.fillStyle = u.color;
            ctx.beginPath(); ctx.arc(u.x, u.y, 35, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#000'; ctx.fillText(u.name, u.x-15, u.y+5);

            // ê³µê²© ë¡œì§
            if (time - u.lastAttack > u.speed * 20 && monsters.length > 0) {
                const target = monsters[0];
                u.lastAttack = time;
                
                // ë°œì‚¬ì²´/ì´í™íŠ¸
                ctx.strokeStyle = u.color;
                ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(u.x, u.y); ctx.lineTo(target.x, target.y); ctx.stroke();
                
                // ë°ë¯¸ì§€ ë° íŠ¹ìˆ˜ëŠ¥ë ¥ ì²˜ë¦¬
                target.hp -= (u.grade * 2);
                if (u.ability === 'ì•½íƒˆ' && Math.random() < u.chance) gold += 1;
                if (u.ability === 'ìŠ¤í„´' && Math.random() < u.chance) target.speed = 0.2; // ì¼ì‹œì  ëŠë ¤ì§
                
                if (target.hp <= 0) {
                    createExplosion(target.x, target.y, '#ff4d4d');
                    monsters.shift();
                    gold += 2;
                }
            }
        });

        // 4. íŒŒí‹°í´ ì—…ë°ì´íŠ¸
        particles = particles.filter(p => p.life > 0);
        particles.forEach(p => p.draw());

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('gold-text').innerText = Math.floor(gold);
        document.getElementById('wave-text').innerText = wave;
        document.getElementById('mob-text').innerText = monsters.length;

        // í•˜ë‹¨ ì†Œí™˜ ë°” UI
        ctx.fillStyle = '#222'; ctx.fillRect(0, 720, 600, 80);
        ctx.fillStyle = '#e74c3c'; ctx.font = 'bold 24px Arial';
        ctx.fillText("TAP TO SPAWN (10G)", 180, 770);

        if (monsters.length >= 50) {
            alert("Game Over!");
            gameState = 'START';
            location.reload();
        }
    }

    requestAnimationFrame(update);
}

// ì´ˆê¸° ì‹¤í–‰
requestAnimationFrame(update);
</script>
</body>
</html>
