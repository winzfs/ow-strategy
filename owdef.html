<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìš´ë¹¨ë””íœìŠ¤: ì´í„°ë„</title>
    <style>
        :root { --p: #00f2ff; --s: #7000ff; --d: #ff0055; --bg: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; font-family: 'Malgun Gothic', sans-serif; }
        
        #game-container {
            position: relative; width: 100vw; height: 100vh; max-width: 500px; max-height: 900px;
            background: var(--bg); overflow: hidden; display: flex; flex-direction: column;
            border: 1px solid #333;
        }

        canvas { display: block; width: 100%; height: 100%; touch-action: none; }

        /* UI ë ˆì´ì–´ */
        .ui-panel { position: absolute; z-index: 10; pointer-events: none; width: 100%; }
        #top-bar { top: 20px; display: flex; justify-content: space-around; }
        .glass-box { background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); text-align: center; min-width: 80px; }
        .label { font-size: 10px; color: #888; margin-bottom: 2px; }
        .val { font-size: 16px; font-weight: bold; color: #fff; }

        /* í™”ë©´ í…œí”Œë¦¿ */
        .screen { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; padding: 20px; }
        h1 { color: var(--p); font-size: 40px; margin-bottom: 10px; text-shadow: 0 0 15px var(--p); }
        .sub-title { color: #888; margin-bottom: 40px; }

        /* ì—…ê·¸ë ˆì´ë“œ ì„¹ì…˜ */
        .upgrade-list { width: 100%; margin-bottom: 30px; }
        .upgrade-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #111; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #222;
            pointer-events: auto;
        }
        .upgrade-info { text-align: left; }
        .up-name { font-weight: bold; font-size: 14px; color: #ddd; }
        .up-lv { font-size: 12px; color: var(--p); }
        
        .btn-action { 
            padding: 15px 40px; background: linear-gradient(45deg, var(--s), var(--p));
            border: none; color: white; border-radius: 10px; font-size: 18px; font-weight: bold;
            cursor: pointer; pointer-events: auto;
        }
        .btn-small { padding: 8px 15px; font-size: 12px; background: #333; border-radius: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="top-bar" class="ui-panel hidden">
            <div class="glass-box"><div class="label">GOLD</div><div class="val" id="gold-val" style="color:var(--p)">100</div></div>
            <div class="glass-box"><div class="label">LIFE</div><div class="val" id="life-val" style="color:var(--d)">50</div></div>
            <div class="glass-box"><div class="label">WAVE</div><div class="val" id="wave-val">1</div></div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="lobby-screen" class="screen">
            <h1>LUCKY<br>ETERNAL</h1>
            <div class="sub-title">ì˜í˜¼ì„: <span id="soul-val" style="color:var(--p)">0</span></div>
            
            <div class="upgrade-list">
                <div class="upgrade-item">
                    <div class="upgrade-info">
                        <div class="up-name">ê³µê²©ë ¥ ê°•í™”</div>
                        <div class="up-lv">Lv.<span id="atk-lv">1</span> (+<span id="atk-bonus">0</span>%)</div>
                    </div>
                    <button class="btn-action btn-small" onclick="upgradeAtk()">ê°•í™” (10ê°œ)</button>
                </div>
                <div class="upgrade-item">
                    <div class="upgrade-info">
                        <div class="up-name">ì´ˆê¸° ê³¨ë“œ</div>
                        <div class="up-lv">Lv.<span id="gold-lv">1</span> (+<span id="gold-bonus">0</span>)</div>
                    </div>
                    <button class="btn-action btn-small" onclick="upgradeGold()">ê°•í™” (15ê°œ)</button>
                </div>
            </div>

            <button class="btn-action" onclick="startGame()">ì „íˆ¬ ì‹œì‘</button>
        </div>

        <div id="over-screen" class="screen hidden">
            <h1 style="color:var(--d)">DEFEAT</h1>
            <div id="result-text" style="color:#aaa; margin-bottom:30px">ìµœì¢… ì›¨ì´ë¸Œ: 1</div>
            <button class="btn-action" onclick="goToLobby()">ë¡œë¹„ë¡œ ì´ë™</button>
        </div>
    </div>

<script>
/** ğŸ‘¨â€ğŸ’» ìƒìš©í™” ì‹œìŠ¤í…œ ì—”ì§„ **/
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const container = document.getElementById('game-container');

// ì €ì¥ëœ ë°ì´í„° (ì˜êµ¬ ì„±ì¥)
let soulStones = parseInt(localStorage.getItem('soulStones')) || 0;
let upgradeAtkLv = parseInt(localStorage.getItem('atkLv')) || 1;
let upgradeGoldLv = parseInt(localStorage.getItem('goldLv')) || 1;

// ê²Œì„ ë‚´ ë³€ìˆ˜
let gold, wave, life, monsters, board, particles;
let gameState = 'LOBBY', spawnTimer = 0, lastTime = 0, dragIdx = null, mx, my;

const GRADES = [
    { name: 'ì¼ë°˜', color: '#fff', power: 5 },
    { name: 'í¬ê·€', color: '#00f2ff', power: 12 },
    { name: 'ì˜ì›…', color: '#7000ff', power: 30 },
    { name: 'ì „ì„¤', color: '#ff0055', power: 70 }
];

let TILE_SIZE, BOARD_X, BOARD_Y, PATH;

function initLayout() {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    TILE_SIZE = Math.min(canvas.width / 4.5, 90);
    BOARD_X = (canvas.width - (TILE_SIZE * 4)) / 2;
    BOARD_Y = canvas.height * 0.35; // ë³´ë“œë¥¼ ì•½ê°„ ìœ„ë¡œ
    
    // ëª¬ìŠ¤í„° ê²½ë¡œ (ë³´ë“œíŒ ì£¼ë³€)
    const offset = 35;
    const pT = BOARD_Y - offset;
    const pB = BOARD_Y + (TILE_SIZE * 4) + offset;
    const pL = BOARD_X - offset;
    const pR = BOARD_X + (TILE_SIZE * 4) + offset;

    PATH = [
        {x1: pL, y1: pT, x2: pR, y2: pT},
        {x1: pR, y1: pT, x2: pR, y2: pB},
        {x1: pR, y1: pB, x2: pL, y2: pB},
        {x1: pL, y1: pB, x2: pL, y2: pT}
    ];
}

window.addEventListener('resize', initLayout);
initLayout();
updateLobbyUI();

function updateLobbyUI() {
    document.getElementById('soul-val').innerText = soulStones;
    document.getElementById('atk-lv').innerText = upgradeAtkLv;
    document.getElementById('atk-bonus').innerText = (upgradeAtkLv - 1) * 5;
    document.getElementById('gold-lv').innerText = upgradeGoldLv;
    document.getElementById('gold-bonus').innerText = (upgradeGoldLv - 1) * 10;
}

function upgradeAtk() {
    if (soulStones >= 10) {
        soulStones -= 10; upgradeAtkLv++;
        saveData(); updateLobbyUI();
    }
}
function upgradeGold() {
    if (soulStones >= 15) {
        soulStones -= 15; upgradeGoldLv++;
        saveData(); updateLobbyUI();
    }
}
function saveData() {
    localStorage.setItem('soulStones', soulStones);
    localStorage.setItem('atkLv', upgradeAtkLv);
    localStorage.setItem('goldLv', upgradeGoldLv);
}

function startGame() {
    gameState = 'PLAY';
    document.getElementById('lobby-screen').classList.add('hidden');
    document.getElementById('top-bar').classList.remove('hidden');
    
    // ì´ˆê¸°í™”
    gold = 100 + (upgradeGoldLv - 1) * 10;
    wave = 1; life = 30; monsters = []; board = Array(16).fill(null); particles = [];
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
}

function goToLobby() {
    gameState = 'LOBBY';
    document.getElementById('over-screen').classList.add('hidden');
    document.getElementById('lobby-screen').classList.remove('hidden');
    document.getElementById('top-bar').classList.add('hidden');
    updateLobbyUI();
}

function gameLoop(time) {
    if (gameState !== 'PLAY') return;
    const dt = time - lastTime;
    lastTime = time;

    ctx.fillStyle = '#050505';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 1. ëª¬ìŠ¤í„° (ê²½ë¡œ)
    spawnTimer += dt;
    if (spawnTimer > Math.max(300, 2000 - (wave * 100))) {
        monsters.push({
            x: PATH[0].x1, y: PATH[0].y1, pathIdx: 0,
            hp: 20 * Math.pow(1.2, wave), maxHp: 20 * Math.pow(1.2, wave), speed: 1.5 + (wave * 0.05)
        });
        spawnTimer = 0;
    }

    monsters.forEach((m, i) => {
        const p = PATH[m.pathIdx];
        const dx = p.x2 - p.x1, dy = p.y2 - p.y1;
        const len = Math.sqrt(dx*dx + dy*dy);
        m.x += (dx/len) * m.speed; m.y += (dy/len) * m.speed;

        if (Math.hypot(m.x - p.x2, m.y - p.y2) < 5) {
            m.pathIdx++;
            if (m.pathIdx >= PATH.length) { life--; monsters.splice(i, 1); return; }
            m.x = PATH[m.pathIdx].x1; m.y = PATH[m.pathIdx].y1;
        }

        ctx.fillStyle = varColor('--d');
        ctx.beginPath(); ctx.arc(m.x, m.y, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#222'; ctx.fillRect(m.x-12, m.y-18, 24, 3);
        ctx.fillStyle = '#0f0'; ctx.fillRect(m.x-12, m.y-18, (m.hp/m.maxHp)*24, 3);
    });

    // 2. ë³´ë“œ & ìœ ë‹›
    for (let i = 0; i < 16; i++) {
        const bx = BOARD_X + (i % 4) * TILE_SIZE;
        const by = BOARD_Y + Math.floor(i / 4) * TILE_SIZE;
        ctx.strokeStyle = '#1a1a1a'; ctx.strokeRect(bx+2, by+2, TILE_SIZE-4, TILE_SIZE-4);

        if (board[i] && dragIdx !== i) {
            drawUnit(board[i], bx + TILE_SIZE/2, by + TILE_SIZE/2);
            updateAttack(board[i], bx + TILE_SIZE/2, by + TILE_SIZE/2, dt);
        }
    }
    if (dragIdx !== null) drawUnit(board[dragIdx], mx, my, true);

    // 3. ì»¨íŠ¸ë¡¤ ì¡´ (ì†Œí™˜ ë²„íŠ¼ í•˜ë‹¨ ë¶„ë¦¬)
    const ctrlY = canvas.height - 120;
    ctx.fillStyle = '#000'; ctx.fillRect(0, ctrlY, canvas.width, 120);
    ctx.strokeStyle = '#222'; ctx.beginPath(); ctx.moveTo(0, ctrlY); ctx.lineTo(canvas.width, ctrlY); ctx.stroke();

    const btnW = canvas.width - 60, btnH = 60;
    ctx.fillStyle = gold >= 10 ? '#7000ff' : '#222';
    ctx.beginPath(); ctx.roundRect((canvas.width-btnW)/2, ctrlY + 20, btnW, btnH, 15); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 18px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(`ìœ ë‹› ì†Œí™˜ (10G)`, canvas.width/2, ctrlY + 57);

    // 4. ì´í™íŠ¸ ë° ìŠ¤íƒ¯
    updateParticles();
    document.getElementById('gold-val').innerText = Math.floor(gold);
    document.getElementById('life-val').innerText = life;
    document.getElementById('wave-val').innerText = wave;

    if (life <= 0) endGame();
    else {
        if (time % 20000 < 20) { wave++; gold += 20; }
        requestAnimationFrame(gameLoop);
    }
}

function drawUnit(u, x, y, isDrag = false) {
    const g = GRADES[u.grade];
    ctx.fillStyle = g.color;
    ctx.shadowBlur = isDrag ? 20 : 10; ctx.shadowColor = g.color;
    ctx.beginPath(); ctx.arc(x, y, TILE_SIZE/3, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#000'; ctx.font = 'bold 12px sans-serif'; ctx.fillText(u.name[0], x, y+5);
}

function updateAttack(u, ux, uy, dt) {
    u.timer = (u.timer || 0) + dt;
    const bonus = 1 + (upgradeAtkLv - 1) * 0.05;
    if (u.timer > (1000 - u.grade*200) && monsters.length > 0) {
        let target = monsters.find(m => Math.hypot(m.x - ux, m.y - uy) < 180);
        if (target) {
            u.timer = 0;
            ctx.strokeStyle = GRADES[u.grade].color; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(ux, uy); ctx.lineTo(target.x, target.y); ctx.stroke();
            target.hp -= GRADES[u.grade].power * bonus;
            if (target.hp <= 0) {
                gold += 2; createExplosion(target.x, target.y, GRADES[u.grade].color);
                monsters.splice(monsters.indexOf(target), 1);
            }
        }
    }
}

function handleStart(e) {
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    mx = cx - rect.left; my = cy - rect.top;

    if (my > canvas.height - 100) { spawnUnit(); return; }
    for (let i = 0; i < 16; i++) {
        const bx = BOARD_X + (i % 4) * TILE_SIZE, by = BOARD_Y + Math.floor(i / 4) * TILE_SIZE;
        if (mx > bx && mx < bx + TILE_SIZE && my > by && my < by + TILE_SIZE) {
            if (board[i]) dragIdx = i;
        }
    }
}

function spawnUnit() {
    const empty = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
    if (empty.length > 0 && gold >= 10) {
        gold -= 10;
        const idx = empty[Math.floor(Math.random() * empty.length)];
        board[idx] = { name: ['K','A','M','R'][Math.floor(Math.random()*4)], grade: 0, timer: 0 };
    }
}

function endGame() {
    gameState = 'OVER';
    const earned = Math.floor(wave * 1.5);
    soulStones += earned;
    saveData();
    document.getElementById('over-screen').classList.remove('hidden');
    document.getElementById('result-text').innerText = `ìµœì¢… ì›¨ì´ë¸Œ: ${wave}\níšë“í•œ ì˜í˜¼ì„: ${earned}`;
}

function createExplosion(x,y,c){for(let i=0;i<10;i++)particles.push({x,y,c,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1})}
function updateParticles(){particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=0.05;ctx.fillStyle=p.c;ctx.globalAlpha=p.life;ctx.fillRect(p.x,p.y,3,3)});particles=particles.filter(p=>p.life>0);ctx.globalAlpha=1}
function varColor(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()}

canvas.addEventListener('mousedown', handleStart);
window.addEventListener('mousemove', (e)=>{
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    mx = cx - rect.left; my = cy - rect.top;
});
window.addEventListener('mouseup', handleEnd);
canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); handleStart(e)}, {passive:false});
window.addEventListener('touchmove', (e)=>{e.preventDefault(); 
    const rect = canvas.getBoundingClientRect();
    mx = e.touches[0].clientX - rect.left; my = e.touches[0].clientY - rect.top;
}, {passive:false});
window.addEventListener('touchend', handleEnd);

function handleEnd() {
    if (dragIdx === null) return;
    let targetIdx = -1;
    for (let i = 0; i < 16; i++) {
        const bx = BOARD_X + (i % 4) * TILE_SIZE, by = BOARD_Y + Math.floor(i / 4) * TILE_SIZE;
        if (mx > bx && mx < bx + TILE_SIZE && my > by && my < by + TILE_SIZE) targetIdx = i;
    }
    if (targetIdx !== -1 && targetIdx !== dragIdx) {
        const a = board[dragIdx], b = board[targetIdx];
        if (b && a.name === b.name && a.grade === b.grade && a.grade < 3) {
            board[targetIdx] = { ...a, grade: a.grade + 1, timer: 0 };
            board[dragIdx] = null;
            createExplosion(mx, my, GRADES[a.grade+1].color);
        } else { board[dragIdx] = b; board[targetIdx] = a; }
    }
    dragIdx = null;
}
</script>
</body>
</html>
