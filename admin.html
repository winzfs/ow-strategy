<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OWHUB ADMIN</title>
    <style>
        :root { --accent: #ff9c00; --bg: #0f0f0f; --card: #1a1a1a; --danger: #ff4d4d; --success: #00e676; --text: #e0e0e0; }
        body { background: var(--bg); color: var(--text); font-family: 'Pretendard', -apple-system, sans-serif; margin: 0; padding: 10px; line-height: 1.5; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        
        /* ìƒë‹¨ í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #000; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        header h2 { margin: 0; font-size: 18px; color: var(--accent); letter-spacing: -1px; }
        .admin-id { font-size: 11px; color: #666; display: block; }

        /* í†µê³„ ì¹´ë“œ (ëª¨ë°”ì¼ 2ì—´) */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #222; text-align: center; }
        .stat-card h3 { margin: 0; font-size: 12px; color: #888; font-weight: 500; }
        .stat-card p { margin: 8px 0 0; font-size: 22px; font-weight: 900; color: var(--accent); }

        /* í…Œì´ë¸” ë° ì¹´ë“œ ë³€í™˜ */
        .list-container { background: transparent; }
        
        /* í…Œì´ë¸” í—¤ë” - ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ¨ê¹€ */
        .table-header { display: none; background: #222; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 13px; color: #888; }

        /* ê°œë³„ ìœ ì € ì¹´ë“œ */
        .user-item { background: var(--card); border-radius: 12px; border: 1px solid #222; padding: 15px; margin-bottom: 12px; position: relative; }
        .user-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .user-main b { font-size: 16px; color: #fff; display: block; margin-bottom: 2px; }
        .user-main small { color: #555; font-size: 11px; word-break: break-all; }
        
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .status-banned { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .status-active { background: rgba(0, 230, 118, 0.1); color: var(--success); border: 1px solid var(--success); }

        /* ê´€ë¦¬ ë„êµ¬í•¨ */
        .management-box { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; }
        .control-row { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        
        input[type="date"] { flex: 1; background: #2a2a2a; border: 1px solid #333; color: white; padding: 10px; border-radius: 6px; font-size: 13px; min-width: 120px; }
        
        .btn { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; }
        .btn-ban { background: #333; color: white; }
        .btn-perma { background: #420000; color: var(--danger); border: 1px solid var(--danger); }
        .btn-unban { background: var(--success); color: black; }
        .btn-reset { background: #004d7a; color: #fff; }

        /* PC ë²„ì „ ëŒ€ì‘ (768px ì´ìƒ) */
        @media (min-width: 768px) {
            body { padding: 30px; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .user-item { display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; align-items: center; gap: 15px; padding: 10px 20px; }
            .user-info { margin-bottom: 0; }
            .management-box { background: none; padding: 0; }
            .control-row { margin-top: 0; }
            .table-header { display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; gap: 15px; padding: 10px 20px; }
        }

        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="lock-screen">ğŸ•µï¸ ê¶Œí•œ í™•ì¸ ì¤‘...</div>

<div class="container">
    <header>
        <div>
            <h2>OWHUB COMMAND</h2>
            <span id="admin-id" class="admin-id">Checking access...</span>
        </div>
        <button class="btn" style="background:#222; color:#888; width:auto; padding:8px 15px;" onclick="location.href='index.html'">EXIT</button>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><h3>TOTAL</h3><p id="stat-total">0</p></div>
        <div class="stat-card"><h3>BANNED</h3><p id="stat-banned" style="color:var(--danger);">0</p></div>
        <div class="stat-card"><h3>PARTY</h3><p id="stat-parties">0</p></div>
        <div class="stat-card"><h3>ONLINE</h3><p id="stat-online">--</p></div>
    </div>

    <div class="table-header">
        <div>USER / UID</div>
        <div>STATUS</div>
        <div>MANNER</div>
        <div>ACTIONS</div>
    </div>

    <div id="user-list" class="list-container">
        </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyA96CFg3o1TpD5lu-0rYMlIp16Ev8URDuw", 
        authDomain: "ow-party-97936.firebaseapp.com", 
        projectId: "ow-party-97936", 
        appId: "1:15782204013:web:5c74ef2e603c311fc82564" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = 'jazzhjm@gmail.com';

    onAuthStateChanged(auth, (user) => {
        if (!user || user.email !== ADMIN_EMAIL) {
            alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            location.href = 'index.html';
            return;
        }
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('admin-id').innerText = user.email;
        loadData();
    });

    function loadData() {
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('user-list');
            let html = "";
            let bannedCount = 0;

            snap.forEach(docSnap => {
                const u = docSnap.data();
                const uid = docSnap.id;
                const isBanned = u.banUntil && u.banUntil > Date.now();
                if(isBanned) bannedCount++;
                const avgRate = u.rateCount > 0 ? (u.rateTotal / u.rateCount).toFixed(1) : "0.0";

                html += `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-main">
                                <b>${u.btag || 'ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì›'}</b>
                                <small>${uid}</small>
                            </div>
                            <span class="status-badge ${isBanned ? 'status-banned' : 'status-active'}">
                                ${isBanned ? 'BANNED' : 'ACTIVE'}
                            </span>
                        </div>
                        
                        <div style="font-size: 13px; color:var(--accent); margin-bottom:10px;">
                            â˜… ${avgRate} <span style="color:#444; font-size:11px;">(${u.rateCount || 0} reviews)</span>
                        </div>

                        <div class="management-box">
                            <div class="control-row">
                                <input type="date" id="date-${uid}">
                                <button class="btn btn-ban" onclick="banUser('${uid}')">ì •ì§€</button>
                            </div>
                            <div class="control-row">
                                <button class="btn btn-perma" onclick="controlBan('${uid}', -1)">ì˜êµ¬</button>
                                ${isBanned ? `<button class="btn btn-unban" onclick="controlBan('${uid}', 0)">í•´ì œ</button>` : ''}
                                <button class="btn btn-reset" onclick="resetRate('${uid}')">ë¦¬ì…‹</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            document.getElementById('stat-total').innerText = snap.size;
            document.getElementById('stat-banned').innerText = bannedCount;
        });

        onSnapshot(query(collection(db, "parties"), where("deleted", "==", false)), (snap) => {
            document.getElementById('stat-parties').innerText = snap.size;
        });
    }

    // ì „ì—­ í•¨ìˆ˜ ì„¤ì • (ì •ì§€, í•´ì œ, ë¦¬ì…‹ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
    window.banUser = async (uid) => {
        const val = document.getElementById(`date-${uid}`).value;
        if(!val) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        const until = new Date(val).getTime();
        if(confirm("í•´ë‹¹ ë‚ ì§œê¹Œì§€ ì •ì§€í• ê¹Œìš”?")) {
            await updateDoc(doc(db, "users", uid), { banUntil: until });
            alert("ì •ì§€ ì™„ë£Œ");
        }
    };

    window.controlBan = async (uid, type) => {
        let banUntil = type === -1 ? 253370764800000 : null;
        if(confirm(type === -1 ? "ì˜êµ¬ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await updateDoc(doc(db, "users", uid), { banUntil: banUntil });
        }
    };

    window.resetRate = async (uid) => {
        if(confirm("ë§¤ë„ˆ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await updateDoc(doc(db, "users", uid), { rateCount: 0, rateTotal: 0 });
        }
    };
</script>
</body>
</html>
