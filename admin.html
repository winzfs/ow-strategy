<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWHUB - ê´€ë¦¬ì ì‹œìŠ¤í…œ</title>
    <style>
        :root { --accent: #ff9c00; --bg-dark: #0a0a0a; --card-bg: #1a1a1a; --danger: #ff3c3c; --success: #00ff7b; }
        body { background: var(--bg-dark); color: white; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #000; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
        .nav-buttons { display: flex; gap: 10px; }
        
        /* í†µê³„ ì˜ì—­ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #333; text-align: center; transition: 0.3s; }
        .stat-card:hover { border-color: var(--accent); }
        .stat-card h3 { margin: 0; font-size: 13px; color: #888; text-transform: uppercase; }
        .stat-card p { margin: 10px 0 0; font-size: 28px; font-weight: 900; color: var(--accent); }

        /* í…Œì´ë¸” ì˜ì—­ */
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid #333; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 14px; }
        th { background: #222; padding: 15px; color: #888; font-weight: 600; border-bottom: 1px solid #333; }
        td { padding: 15px; border-bottom: 1px solid #222; vertical-align: middle; }
        tr:hover { background: rgba(255,156,0,0.05); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-home { background: transparent; border: 1px solid #444; color: #ccc; }
        .btn-ban { background: #444; color: white; }
        .btn-perma { background: var(--danger); color: white; }
        .btn-reset { background: #00a2ff; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }

        /* ìƒíƒœ ë°°ì§€ */
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-banned { background: var(--danger); color: white; }
        .status-active { background: var(--success); color: black; }

        /* ë¡œë”©/ì ê¸ˆ í™”ë©´ */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="spinner"></div>
    <h2 id="lock-text">ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì¤‘...</h2>
</div>

<div class="container">
    <header>
        <div>
            <h2 style="margin:0; color:var(--accent);">OWHUB COMMAND CENTER</h2>
            <p id="admin-info" style="margin:5px 0 0; font-size:12px; color:#666;">ì ‘ì† ê³„ì •: ë¡œë”© ì¤‘...</p>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-home" onclick="location.href='index.html'">ë©”ì¸ í”¼ë“œë¡œ ì´ë™</button>
            <button class="btn btn-perma" onclick="auth.signOut().then(()=>location.href='index.html')">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><h3>ë“±ë¡ ìœ ì›</h3><p id="stat-users">0</p></div>
        <div class="stat-card"><h3>í™œì„± ëª¨ì§‘</h3><p id="stat-parties">0</p></div>
        <div class="stat-card"><h3>ì‹ ê³  ëˆ„ì </h3><p id="stat-reports">0</p></div>
        <div class="stat-card"><h3>ì •ì§€ ìš”ì›</h3><p id="stat-banned">0</p></div>
    </div>

    <div class="table-container">
        <div style="padding:20px; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">ğŸ‘¥ ìœ ì € ë§¤ë‹ˆì§€ë¨¼íŠ¸</h3>
            <span style="font-size:12px; color:#888;">ì •ì§€ëœ ìœ ì €ëŠ” ë¡œê·¸ì¸ ì‹œ ì¦‰ì‹œ ì°¨ë‹¨ë©ë‹ˆë‹¤.</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ì‚¬ìš©ì ì •ë³´ (UID)</th>
                    <th>ìƒíƒœ</th>
                    <th>ë§¤ë„ˆ ë³„ì </th>
                    <th>ì œì¬ ë° ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyA96CFg3o1TpD5lu-0rYMlIp16Ev8URDuw", 
        authDomain: "ow-party-97936.firebaseapp.com", 
        projectId: "ow-party-97936", 
        appId: "1:15782204013:web:5c74ef2e603c311fc82564" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = 'jazzhjm@gmail.com';

    // ë³´ì•ˆ ë° ê¶Œí•œ ì²´í¬
    onAuthStateChanged(auth, async (user) => {
        const lockText = document.getElementById('lock-text');
        if (!user) {
            lockText.innerText = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.";
            setTimeout(() => location.href = 'index.html', 1500);
            return;
        }
        if (user.email !== ADMIN_EMAIL) {
            lockText.innerText = "ê²½ê³ : ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
            setTimeout(() => location.href = 'index.html', 1500);
            return;
        }

        document.getElementById('admin-info').innerText = `ê´€ë¦¬ì: ${user.email}`;
        document.getElementById('lock-screen').style.display = 'none';
        
        initDashboard();
    });

    function initDashboard() {
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        onSnapshot(collection(db, "users"), (snap) => {
            renderUserTable(snap);
            updateStats(snap);
        });
        
        onSnapshot(query(collection(db, "parties"), where("deleted", "==", false)), (snap) => {
            document.getElementById('stat-parties').innerText = snap.size;
        });
    }

    function updateStats(usersSnap) {
        let bannedCount = 0;
        usersSnap.forEach(d => {
            if (d.data().banUntil && d.data().banUntil > Date.now()) bannedCount++;
        });
        document.getElementById('stat-users').innerText = usersSnap.size;
        document.getElementById('stat-banned').innerText = bannedCount;
        document.getElementById('stat-reports').innerText = "ê´€ë¦¬ì¤‘";
    }

    function renderUserTable(snap) {
        const body = document.getElementById('user-table-body');
        let html = "";

        snap.forEach(docSnap => {
            const u = docSnap.data();
            const uid = docSnap.id;
            const isBanned = u.banUntil && u.banUntil > Date.now();
            const avgRate = u.rateCount > 0 ? (u.rateTotal / u.rateCount).toFixed(1) : "0.0";
            
            html += `
                <tr>
                    <td>
                        <div style="font-weight:bold; font-size:15px;">${u.btag || 'ë¯¸ì„¤ì • ìš”ì›'}</div>
                        <div style="font-size:11px; color:#555; margin-top:2px;">${uid}</div>
                    </td>
                    <td>
                        <span class="status-badge ${isBanned ? 'status-banned' : 'status-active'}">
                            ${isBanned ? 'ì ‘ê·¼ ì œí•œ' : 'ì •ìƒ ìš”ì›'}
                        </span>
                    </td>
                    <td><b style="color:var(--accent);">â˜… ${avgRate}</b> <small style="color:#666;">(${u.rateCount || 0}íšŒ)</small></td>
                    <td>
                        <button class="btn btn-ban" onclick="controlBan('${uid}', 7)">7ì¼ ì •ì§€</button>
                        <button class="btn btn-perma" onclick="controlBan('${uid}', -1)">ì˜êµ¬ ì •ì§€</button>
                        <button class="btn btn-reset" onclick="resetRate('${uid}')">ë¦¬ì…‹</button>
                        ${isBanned ? `<button class="btn btn-home" onclick="controlBan('${uid}', 0)" style="border-color:var(--success); color:var(--success);">í•´ì œ</button>` : ''}
                    </td>
                </tr>
            `;
        });
        body.innerHTML = html;
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
    window.controlBan = async (uid, days) => {
        let banDate;
        let reason = "ìš´ì˜ ì •ì±… ìœ„ë°˜ ë° ì»¤ë®¤ë‹ˆí‹° ë§¤ë„ˆ ì¤€ìˆ˜ ìœ„ë°˜";

        if (days === 0) {
            if(!confirm("í•´ë‹¹ ìœ ì €ì˜ ì •ì§€ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            banDate = null;
        } else if (days === -1) {
            if(!confirm("âš ï¸ [ì˜êµ¬ ì •ì§€] ì •ë§ë¡œ ì´ ê³„ì •ì„ ì˜êµ¬ ì œëª…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            banDate = 253370764800000; // 9999ë…„
        } else {
            if(!confirm(`${days}ì¼ê°„ ì •ì§€ ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            banDate = Date.now() + (days * 24 * 60 * 60 * 1000);
        }

        await updateDoc(doc(db, "users", uid), {
            banUntil: banDate,
            banReason: reason
        });
        alert("ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    };

    window.resetRate = async (uid) => {
        if(confirm("ì´ ìœ ì €ì˜ ëª¨ë“  ë³„ì  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            await updateDoc(doc(db, "users", uid), {
                rateCount: 0,
                rateTotal: 0
            });
            alert("ì´ˆê¸°í™” ì™„ë£Œ");
        }
    };
</script>

</body>
</html>
