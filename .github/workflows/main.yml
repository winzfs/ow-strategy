import os
import json
import requests
from datetime import datetime

# ëª…ë‹¨ (ì±„ë„ ID)
PRO_PLAYERS = {
    "ì•ˆìŠ¤ (Ans)": "UC9ghJjR2aiuvhudqw8dM__g",
    "í•™ì‚´ (Haksal)": "UC8f4_B985QvM_S3m5v7zW2g",
    "ë¥˜ì œí™ (Ryujehong)": "UC0h_uVqO_JInU6LzT_N6_NQ",
    "ë¦½ (Lip)": "UC7-Q_vW1V06Y_X7V_S37N-A"
}

STREAMERS = {
    "ë¯¸ë¼ì§€": "UC69SOf9BovX2uS_vGId07Pw",
    "ë¹…í—¤ë“œ": "UCVp69S_pU6sgvS_uL5u-4_w"
}

API_KEY = os.environ.get('YOUTUBE_API_KEY')

def get_latest_by_search(name, channel_id):
    if not API_KEY: return None
    # 'order=date'ì™€ 'type=video'ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ì±„ë„ì˜ ê°€ì¥ ìµœì‹  ì˜ìƒì„ ê²€ìƒ‰
    url = f"https://www.googleapis.com/youtube/v3/search?part=snippet&channelId={channel_id}&maxResults=1&order=date&type=video&key={API_KEY}"
    
    try:
        response = requests.get(url, timeout=10)
        res = response.json()
        
        if 'items' in res and len(res['items']) > 0:
            item = res['items'][0]
            return {
                "id": item['id']['videoId'],
                "title": item['snippet']['title'],
                "player": name
            }
        else:
            print(f"ì •ë³´ ì—†ìŒ: {name}")
    except Exception as e:
        print(f"API ì—ëŸ¬ ({name}): {e}")
    return None

def get_category_videos(query, label):
    # ì¼ë°˜ ì¹´í…Œê³ ë¦¬(ê³µì‹ ì†Œì‹ ë“±) ê²€ìƒ‰
    url = f"https://www.googleapis.com/youtube/v3/search?part=snippet&q={query}&maxResults=6&order=date&type=video&key={API_KEY}"
    try:
        res = requests.get(url).json()
        return [{"id": i['id']['videoId'], "title": i['snippet']['title'], "player": label} for i in res.get('items', [])]
    except:
        return []

def main():
    print("ğŸš€ ê²€ìƒ‰ ê¸°ë°˜ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...")
    data = {
        "lastUpdated": datetime.now().strftime('%Y-%m-%d %H:%M'),
        "pro": [], "streamer": [], "official": [], "trending": []
    }

    # 1. í”„ë¡œ ì„ ìˆ˜ (ì±„ë„ ë‚´ ìµœì‹  ì˜ìƒ 1ê°œì”©)
    for name, cid in PRO_PLAYERS.items():
        v = get_latest_by_search(name, cid)
        if v: 
            data["pro"].append(v)
            print(f"âœ… ì¶”ê°€ë¨: {name}")

    # 2. ìŠ¤íŠ¸ë¦¬ë¨¸ (ì±„ë„ ë‚´ ìµœì‹  ì˜ìƒ 1ê°œì”©)
    for name, cid in STREAMERS.items():
        v = get_latest_by_search(name, cid)
        if v: data["streamer"].append(v)

    # 3. ê³µì‹ ë° ì¸ê¸° ì˜ìƒ (í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ ì—¬ëŸ¬ ê°œ)
    data["official"] = get_category_videos("ì˜¤ë²„ì›Œì¹˜2 ê³µì‹ ì±„ë„", "Official")
    data["trending"] = get_category_videos("ì˜¤ë²„ì›Œì¹˜2 í•˜ì´ë¼ì´íŠ¸ ë§¤ë“œë¬´ë¹„", "Trending")

    # ê²°ê³¼ ì €ì¥
    with open('news.json', 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    print("ğŸ‰ ëª¨ë“  íƒ­ ë°ì´í„° ì €ì¥ ì™„ë£Œ!")

if __name__ == "__main__":
    main()
