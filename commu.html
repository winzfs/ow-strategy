<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë²„ì›Œì¹˜ í—ˆë¸Œ ì»¤ë®¤ë‹ˆí‹°</title>
    <style>
        :root { --accent: #ff9c00; --bg-dark: #111; }
        body { background: var(--bg-dark); color: white; font-family: 'Pretendard', sans-serif; margin: 0; padding-bottom: 50px; }
        nav { background: #000; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .nav-left { display: flex; gap: 20px; align-items: center; }
        .nav-tabs { display: flex; gap: 20px; align-items: center; }
        .nav-tabs a { color:#888; text-decoration: none; font-weight: 600; font-size: 14px; }
        .container { max-width: 800px; margin: 30px auto; padding: 0 15px; }
        .box { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; position: relative; }
        .btn-main { background: var(--accent); color: black; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-sub { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        input, textarea { background: #252525; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-family: inherit; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        #sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100%; background: #1a1a1a; z-index: 1000; transition: 0.3s; box-shadow: 5px 0 15px rgba(0,0,0,0.5); padding: 20px; box-sizing: border-box; }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        
        .comment-item { margin-bottom: 8px; padding: 8px; background: #111; border-radius: 6px; font-size: 13px; border-left: 3px solid var(--accent); }
    </style>
</head>
<body>

<nav>
    <div class="nav-left">
        <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;">â˜°</button>
        <div class="nav-tabs">
            <a href="index.html">íŒŒí‹°ì°¾ê¸°</a>
            <div style="color:var(--accent); border-bottom: 2px solid var(--accent);">ì»¤ë®¤ë‹ˆí‹°</div>
        </div>
    </div>
    <div id="auth-ui"></div>
</nav>

<div id="sidebar">
    <h3 style="color:var(--accent);">MY PAGE</h3>
    <div id="my-info" style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
        <h2 id="my-btag-display" style="font-size:16px;">-</h2>
        <div id="sidebar-logout-container"></div>
    </div>
    <h4 style="font-size:14px; color:#888;">ğŸ“ ë‚´ê°€ ì“´ ê²Œì‹œê¸€</h4>
    <div id="my-posts-list"></div>
</div>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="container">
    <div class="box">
        <h4 style="color:var(--accent); margin:0 0 10px 0;">ğŸ’¬ ììœ ê²Œì‹œíŒ</h4>
        <input type="text" id="comm-title" placeholder="ì œëª©">
        <textarea id="comm-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4"></textarea>
        <button class="btn-main" id="btn-comm-post">ê¸€ ë“±ë¡í•˜ê¸°</button>
    </div>
    <div id="comm-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, getDocs, deleteDoc, updateDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyA96CFg3o1TpD5lu-0rYMlIp16Ev8URDuw", 
        authDomain: "ow-party-97936.firebaseapp.com", 
        projectId: "ow-party-97936", 
        storageBucket: "ow-party-97936.firebasestorage.app", 
        messagingSenderId: "15782204013", 
        appId: "1:15782204013:web:5c74ef2e603c311fc82564" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let myBtag = "ìµëª…";

    onAuthStateChanged(auth, async (user) => {
        const authUI = document.getElementById('auth-ui');
        const sidebarLogout = document.getElementById('sidebar-logout-container');
        if (user) {
            const userSnap = await getDoc(doc(db, "users", user.uid));
            myBtag = userSnap.exists() ? userSnap.data().btag : "ìµëª…";
            document.getElementById('my-btag-display').innerText = myBtag;
            authUI.innerHTML = `<button onclick="auth.signOut().then(()=>location.reload())" class="btn-sub">ë¡œê·¸ì•„ì›ƒ</button>`;
            sidebarLogout.innerHTML = `<button class="btn-sub" style="width:100%;" onclick="auth.signOut().then(()=>location.reload())">ë¡œê·¸ì•„ì›ƒ</button>`;
        } else {
            authUI.innerHTML = `<button onclick="location.href='index.html'" class="btn-sub">ë¡œê·¸ì¸</button>`;
        }
        startListing();
    });

    function startListing() {
        const q = query(collection(db, "community"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('comm-list');
            list.innerHTML = snap.docs.map(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                return `
                    <div class="box" id="post-${id}">
                        <div style="font-size:12px; color:#888;">${d.author}</div>
                        <h4 style="margin:8px 0;">${d.title}</h4>
                        <p style="font-size:14px; color:#ccc; white-space:pre-wrap;">${d.content}</p>
                        <div style="display:flex; gap:15px; margin-top:10px; border-top:1px solid #222; padding-top:10px;">
                            <span onclick="window.toggleLike('${id}', '${d.uid}')" style="cursor:pointer; font-size:13px; color:#ff9c00;">ğŸ§¡ ì¶”ì²œ ${(d.likes || []).length}</span>
                            <span onclick="window.toggleComments('${id}')" style="cursor:pointer; font-size:13px; color:#888;">ğŸ’¬ ëŒ“ê¸€ ${d.commentCount || 0}</span>
                        </div>
                        <div id="cmt-sec-${id}" style="display:none; margin-top:10px;">
                            <div id="cmt-list-${id}"></div>
                            <div style="display:flex; gap:5px; margin-top:10px;">
                                <input type="text" id="cmt-in-${id}" placeholder="ëŒ“ê¸€ ì…ë ¥..." style="margin:0; font-size:12px;">
                                <button onclick="window.addComment('${id}')" class="btn-main" style="width:60px; margin:0; padding:5px; font-size:12px;">ë“±ë¡</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        });
    }

    // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ìƒ‰ì¸ ì˜¤ë¥˜ í•´ê²° ë²„ì „)
    window.toggleComments = async (id) => {
        const sec = document.getElementById(`cmt-sec-${id}`);
        sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
        
        if(sec.style.display === 'block') {
            const cmtList = document.getElementById(`cmt-list-${id}`);
            cmtList.innerHTML = "<p style='font-size:11px; color:#555;'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
            
            // orderByë¥¼ ì œê±°í•˜ì—¬ ìƒ‰ì¸ ì˜¤ë¥˜ë¥¼ í”¼í•¨
            const q = query(collection(db, "comments"), where("postId", "==", id));
            onSnapshot(q, (snap) => {
                if(snap.empty) {
                    cmtList.innerHTML = "<p style='font-size:11px; color:#555;'>ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>";
                    return;
                }
                // ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìˆ˜ë™ ì •ë ¬ (ì‹œê°„ìˆœ)
                const docs = snap.docs.map(d => d.data()).sort((a,b) => a.createdAt - b.createdAt);
                cmtList.innerHTML = docs.map(c => `
                    <div class="comment-item">
                        <b style="color:var(--accent);">${c.author}</b>: ${c.content}
                    </div>`).join('');
            });
        }
    };

    window.addComment = async (id) => {
        const user = auth.currentUser;
        const input = document.getElementById(`cmt-in-${id}`);
        if(!user) return alert("ë¡œê·¸ì¸ í•„ìš”!");
        if(!input.value.trim()) return;

        try {
            await addDoc(collection(db, "comments"), {
                postId: id,
                uid: user.uid,
                author: myBtag.split('#')[0],
                content: input.value,
                createdAt: Date.now()
            });
            const postRef = doc(db, "community", id);
            const postSnap = await getDoc(postRef);
            await updateDoc(postRef, { commentCount: (postSnap.data().commentCount || 0) + 1 });
            input.value = "";
        } catch(e) { alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + e.message); }
    };

    // ì‚¬ì´ë“œë°” - ë‚´ê°€ ì“´ ê¸€ (ìƒ‰ì¸ ì˜¤ë¥˜ í•´ê²° ë²„ì „)
    window.toggleSidebar = async () => {
        const sb = document.getElementById('sidebar');
        const isOpen = sb.style.left === '0px';
        sb.style.left = isOpen ? '-300px' : '0px';
        document.getElementById('sidebar-overlay').style.display = isOpen ? 'none' : 'block';
        
        if(!isOpen && auth.currentUser) {
            const listContainer = document.getElementById('my-posts-list');
            listContainer.innerHTML = "<p style='font-size:11px; color:#555;'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
            const q = query(collection(db, "community"), where("uid", "==", auth.currentUser.uid));
            const snap = await getDocs(q);
            if(snap.empty) {
                listContainer.innerHTML = "ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            const myDocs = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => b.createdAt - a.createdAt);
            listContainer.innerHTML = myDocs.map(d => `
                <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:8px; font-size:12px; cursor:pointer;" onclick="location.href='#post-${d.id}'; toggleSidebar();">
                    ${d.title}
                </div>`).join('');
        }
    };

    document.getElementById('btn-comm-post').onclick = async () => {
        const user = auth.currentUser;
        if(!user) return alert("ë¡œê·¸ì¸ í•„ìš”!");
        const title = document.getElementById('comm-title').value;
        const content = document.getElementById('comm-content').value;
        if(!title || !content) return;
        await addDoc(collection(db, "community"), {
            uid: user.uid, author: myBtag.split('#')[0], title, content,
            createdAt: Date.now(), likes: [], commentCount: 0
        });
        document.getElementById('comm-title').value = ""; document.getElementById('comm-content').value = "";
    };

    window.toggleLike = async (postId, authorUid) => {
        const user = auth.currentUser;
        if (!user) return alert("ë¡œê·¸ì¸ í•„ìš”!");
        if (user.uid === authorUid) return alert("ë³¸ì¸ ê¸€ ì¶”ì²œ ë¶ˆê°€!");
        const ref = doc(db, "community", postId);
        const snap = await getDoc(ref);
        const likes = snap.data().likes || [];
        await updateDoc(ref, { likes: likes.includes(user.uid) ? arrayRemove(user.uid) : arrayUnion(user.uid) });
    };
</script>
</body>
</html>
