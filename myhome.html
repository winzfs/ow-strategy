<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>16비트 쿼터뷰 마이홈 테스터</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #222; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; }
        #ui-panel { color: white; padding: 10px; background: #333; width: 100%; text-align: center; }
        canvas { border: 4px solid #555; image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="ui-panel">
    <h3>16-Bit MyHome Builder</h3>
    <p>클릭하여 가구 배치 | 'S' 키로 저장 (콘솔확인)</p>
    <button onclick="pickItem('bed')">침대 (Red)</button>
    <button onclick="pickItem('table')">테이블 (Green)</button>
    <button onclick="pickItem('plant')">화분 (Blue)</button>
</div>

<script>
const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    backgroundColor: '#4488aa',
    scene: { preload: preload, create: create, update: update }
};

const game = new Phaser.Game(config);
let selectedItem = 'bed';
let mapItems = [];
let previewItem;

function preload() {
    // 실제 16비트 애셋이 있다면 여기서 로드합니다.
    // this.load.image('bed', 'bed_iso.png');
}

function create() {
    const scene = this;
    
    // 1. 바닥 타일 (Isometric Grid) 그리기
    const tileWidth = 64;
    const tileHeight = 32;
    const mapSize = 8;

    for (let x = 0; x < mapSize; x++) {
        for (let y = 0; y < mapSize; y++) {
            let tx = (x - y) * (tileWidth / 2) + 400;
            let ty = (x + y) * (tileHeight / 2) + 150;
            
            let tile = scene.add.graphics();
            tile.lineStyle(1, 0xeeeeee, 0.3);
            tile.strokePoints([
                {x: tx, y: ty - tileHeight/2},
                {x: tx + tileWidth/2, y: ty},
                {x: tx, y: ty + tileHeight/2},
                {x: tx - tileWidth/2, y: ty}
            ], true);
        }
    }

    // 2. 가구 배치 미리보기용 객체
    previewItem = scene.add.rectangle(0, 0, 40, 60, 0xffffff, 0.5);
    previewItem.setOrigin(0.5, 1);

    // 3. 클릭 이벤트: 가구 배치
    scene.input.on('pointerdown', (pointer) => {
        // 화면 좌표 -> 아이소메트릭 좌표 역계산
        let mx = pointer.x - 400;
        let my = pointer.y - 150;
        
        let isoX = Math.floor((my / (tileHeight/2) + mx / (tileWidth/2)) / 2);
        let isoY = Math.floor((my / (tileHeight/2) - mx / (tileWidth/2)) / 2);

        if (isoX >= 0 && isoX < mapSize && isoY >= 0 && isoY < mapSize) {
            placeFurniture(scene, isoX, isoY);
        }
    });

    // 저장 키 설정
    scene.input.keyboard.on('keydown-S', () => {
        console.log("저장된 데이터:", JSON.stringify(mapItems));
        alert("배치 데이터가 콘솔에 출력되었습니다. 관리자에게 전송 준비 완료!");
    });
}

function update() {
    // 마우스 따라다니는 미리보기 로직
    const pointer = this.input.activePointer;
    let mx = pointer.x - 400;
    let my = pointer.y - 150;
    
    let isoX = Math.floor((my / 16 + mx / 32) / 2);
    let isoY = Math.floor((my / 16 - mx / 32) / 2);

    previewItem.x = (isoX - isoY) * 32 + 400;
    previewItem.y = (isoX + isoY) * 16 + 150;
}

function placeFurniture(scene, x, y) {
    let color;
    if (selectedItem === 'bed') color = 0xff4444;
    else if (selectedItem === 'table') color = 0x44ff44;
    else color = 0x4444ff;

    let tx = (x - y) * 32 + 400;
    let ty = (x + y) * 16 + 150;

    let item = scene.add.rectangle(tx, ty, 40, 60, color);
    item.setStrokeStyle(2, 0x000000);
    item.setOrigin(0.5, 1); // 발치를 기준으로 세움
    
    // 뎁스 정렬: Y 좌표가 높을수록 앞에 보이게 함
    item.setDepth(ty);

    mapItems.push({ type: selectedItem, x: x, y: y });
}

function pickItem(type) {
    selectedItem = type;
}
</script>
</body>
</html>
