<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OW HUB - OWCS EDITION</title>
    
    <meta name="google-site-verification" content="7OvWXc4oEGF5-Aub2pEWiCaBatEsSzA4Im454PrJ0kM" />
    <meta name="theme-color" content="#ff9c00">
    <meta name="keywords" content="Ïò§Î≤ÑÏõåÏπò ÌååÌã∞Ï∞æÍ∏∞, Ïò§Î≤ÑÏõåÏπò2 Í∑∏Î£πÏ∞æÍ∏∞, Ïò§Î≤ÑÏõåÏπò Ïª§ÎÆ§ÎãàÌã∞, Ïò§Î≤ÑÏõåÏπò ÎìÄÏò§, Ïò§Î≤ÑÏõåÏπò Ìã∞Ïñ¥Î≥Ñ Îß§Ïπ≠, owhub">
    <meta name="description" content="Ïò§Î≤ÑÏõåÏπò2 Ïã§ÏãúÍ∞Ñ ÌååÌã∞ Îß§Ïπ≠ ÏÑúÎπÑÏä§!">

    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --accent: #ff9c00; 
            --accent-glow: rgba(255, 156, 0, 0.4);
            --bg-dark: #050505; 
            --box-bg: #121212;
            --tank: #00a2ff; --dps: #ff3c3c; --sup: #00ff7b;
            --owcs-skew: skewX(-12deg);
        }

        body { 
            background: var(--bg-dark); color: white; font-family: 'Noto Sans KR', sans-serif; 
            margin: 0; padding-bottom: 60px; overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 70%);
        }

        /* --- UI COMPONENTS (OWCS STYLE) --- */
        nav { 
            background: rgba(0, 0, 0, 0.9); padding: 0 20px; display: flex; 
            justify-content: space-between; align-items: center; 
            border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 1000; height: 60px;
        }
        .nav-logo { 
            font-family: 'Black Han Sans', sans-serif; font-size: 24px; color: white; 
            transform: var(--owcs-skew); text-shadow: 3px 3px 0px var(--accent); cursor: pointer;
        }

        /* Hamburger Menu */
        .hamburger { cursor: pointer; display: flex; flex-direction: column; gap: 5px; z-index: 1100; position: relative; }
        .hamburger span { width: 25px; height: 3px; background: white; transition: 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 6px); background: var(--accent); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -7px); background: var(--accent); }

        /* Sidebar */
        .sidebar {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: #0a0a0a; border-right: 2px solid var(--accent); z-index: 1050;
            transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); padding: 80px 0 20px 0;
            box-shadow: 20px 0 50px rgba(0,0,0,0.8);
        }
        .sidebar.active { left: 0; }
        .sidebar-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 1040; display: none; backdrop-filter: blur(5px);
        }
        .sidebar-menu-item {
            padding: 15px 30px; font-weight: 900; font-size: 18px; color: #888;
            border-left: 5px solid transparent; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .sidebar-menu-item:hover, .sidebar-menu-item.active { 
            color: var(--accent); background: #111; border-left-color: var(--accent); padding-left: 40px;
        }

        /* Container & Boxes */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .box { 
            background: var(--box-bg); padding: 20px; margin-bottom: 15px; border: 1px solid #222;
            border-left: 5px solid #333; position: relative; transition: 0.3s;
        }
        .box:hover { border-left-color: var(--accent); transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        /* Buttons */
        .btn-main { 
            background: var(--accent); color: black; border: none; padding: 14px; 
            font-weight: 900; cursor: pointer; width: 100%; transform: var(--owcs-skew);
            transition: 0.2s; box-shadow: 4px 4px 0px #000; text-transform: uppercase;
        }
        .btn-main span { transform: skewX(12deg); display: block; }
        .btn-main:hover { background: white; transform: var(--owcs-skew) translate(-2px, -2px); box-shadow: 6px 6px 0px var(--accent); }
        .btn-main:disabled { background: #444; cursor: not-allowed; box-shadow: none; transform: var(--owcs-skew); color: #888; }

        .btn-sub { background: #222; color: #fff; border: 1px solid #444; padding: 10px; cursor: pointer; transform: var(--owcs-skew); font-weight: 700; }

        /* Inputs */
        input, select, textarea { 
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; 
            width: 100%; box-sizing: border-box; margin-bottom: 10px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--accent); }

        /* Live Status Bar */
        #live-status-bar { 
            background: #000; padding: 10px 20px; font-size: 11px; font-weight: 800;
            display: flex; justify-content: space-between; border-bottom: 1px solid #222;
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* Badges */
        .pos-badge-inline { 
            padding: 5px 12px; font-weight: 900; transform: var(--owcs-skew); border-radius: 0;
            display: inline-flex; align-items: center; gap: 5px; font-size: 13px;
        }
        .pos-badge-inline span { transform: skewX(12deg); }
        
        .filter-tag { padding: 8px 15px !important; transform: var(--owcs-skew); font-weight: 900 !important; cursor: pointer; transition: 0.2s; border: 1px solid transparent !important; }
        .filter-tag.active { border: 2px solid white !important; box-shadow: 0 0 10px var(--accent-glow); }

        /* Modals */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }

        /* Animation */
        .menu-new { background: var(--dps); padding: 2px 6px; font-size: 10px; color: white; transform: var(--owcs-skew); margin-left: 5px; }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav>
        <div class="hamburger" id="hamburger-btn" onclick="toggleSidebar()">
            <span></span><span></span><span></span>
        </div>
        <div class="nav-logo" onclick="location.href='index.html'">OWCS // HUB</div>
        <div id="nav-new-badge" style="display:none; width:10px; height:10px; background:var(--dps); border-radius:50%; position:absolute; left:40px; top:15px;"></div>
    </nav>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div style="padding: 0 30px 20px 30px; border-bottom: 1px solid #222; margin-bottom: 20px;">
            <div id="sidebar-user-tag" style="display:none;">
                <p style="font-size: 11px; color: #555; margin: 0;">AGENT AUTHENTICATED</p>
                <p id="display-btag" style="font-size: 18px; font-weight: 900; color: white; margin: 5px 0;"></p>
            </div>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-item active" id="sidebar-list" onclick="showPageAndClose('list')">Find Party</div>
            <div class="sidebar-menu-item" id="sidebar-profile" onclick="showPageAndClose('profile')">My Intel</div>
            <div class="sidebar-menu-item" id="sidebar-noti" onclick="showPageAndClose('noti')">
                COMMS <span id="sidebar-new-tag" class="menu-new" style="display:none;">NEW</span>
            </div>
            <div class="sidebar-menu-item" onclick="location.href='commu.html'">Community</div>
        </div>
        <div style="padding: 30px;">
            <div id="login-form-sidebar">
                <input type="email" id="login-email" placeholder="EMAIL">
                <input type="password" id="login-password" placeholder="PASSWORD">
                <button id="btn-login" class="btn-main"><span>SIGN IN / JOIN</span></button>
            </div>
            <div id="user-info-sidebar" style="display:none;">
                <button id="btn-logout" class="btn-sub" style="width:100%; border-color:#ff3c3c; color:#ff3c3c;">DISCONNECT</button>
            </div>
        </div>
    </div>

    <div id="live-status-bar">
        <span id="live-user-count" style="color:var(--sup);">LIVE AGENTS: --</span>
        <span id="live-party-count" style="color:var(--accent);">MISSIONS IN PROGRESS: 0</span>
    </div>

    <div class="container">
        <div id="page-list" class="page active">
            <div class="box" style="border-left-color: var(--accent);">
                <h4 style="margin: 0 0 15px 0; font-family:'Black Han Sans'; color:var(--accent); letter-spacing:1px;">// START NEW MISSION</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="post-main-pos">
                        <option value="ÌÉ±Ïª§">üõ°Ô∏è TANK</option>
                        <option value="ÎîúÎü¨">‚öîÔ∏è DPS</option>
                        <option value="ÏßÄÏõê">üíâ SUP</option>
                    </select>
                    <div style="display:flex; gap:5px;">
                        <select id="post-tier">
                            <option value="Î∞∞Ïπò">UNRANKED</option>
                            <option value="Î∏åÎ°†Ï¶à">BRONZE</option>
                            <option value="Ïã§Î≤Ñ">SILVER</option>
                            <option value="Í≥®Îìú" selected>GOLD</option>
                            <option value="ÌîåÎûòÌã∞ÎÑò">PLATINUM</option>
                            <option value="Îã§Ïù¥ÏïÑÎ™¨Îìú">DIAMOND</option>
                            <option value="ÎßàÏä§ÌÑ∞">MASTER</option>
                            <option value="Í∑∏ÎûúÎìúÎßàÏä§ÌÑ∞">GM</option>
                            <option value="Ï±îÌîºÏñ∏">CHAMPION</option>
                        </select>
                        <select id="post-tier-num" style="width:60px;"><option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option></select>
                    </div>
                </div>
                <input type="text" id="post-btag" placeholder="BATTLETAG#1234">
                <select id="post-maxp">
                    <option value="2">2Ïù∏ Í∑∏Î£π</option><option value="3">3Ïù∏ Í∑∏Î£π</option><option value="4">4Ïù∏ Í∑∏Î£π</option><option value="5" selected>5Ïù∏ Í∑∏Î£π</option>
                </select>
                <textarea id="post-desc" placeholder="MISSION DETAILS (MIC, HEROES, ETC.)" rows="2"></textarea>
                <button id="btn-post" class="btn-main"><span>DEPLOY MISSION</span></button>
            </div>

            <div class="box" style="background:#000;">
                <p style="font-size:11px; font-weight:900; color:#555; margin-bottom:10px;">FILTER BY INTEL</p>
                <div id="filter-pos-group" style="display:flex; gap:8px; margin-bottom:12px;">
                    <span onclick="toggleFilter('pos', 'ÌÉ±Ïª§', this)" class="badge filter-tag" style="background:var(--tank);">TANK</span>
                    <span onclick="toggleFilter('pos', 'ÎîúÎü¨', this)" class="badge filter-tag" style="background:var(--dps);">DPS</span>
                    <span onclick="toggleFilter('pos', 'ÏßÄÏõê', this)" class="badge filter-tag" style="background:var(--sup); color:black;">SUP</span>
                </div>
                <div id="filter-tier-group" style="display:flex; flex-wrap:wrap; gap:6px;">
                    <span onclick="toggleFilter('tier', 'Î∞∞Ïπò', this)" class="badge filter-tag" style="background:#444;">UNRANK</span>
                    <span onclick="toggleFilter('tier', 'Í≥®Îìú', this)" class="badge filter-tag" style="background:#cd7f32;">GOLD</span>
                    <span onclick="toggleFilter('tier', 'ÌîåÎûòÌã∞ÎÑò', this)" class="badge filter-tag" style="background:#e5e4e2; color:black;">PLAT</span>
                    <span onclick="toggleFilter('tier', 'Îã§Ïù¥ÏïÑÎ™¨Îìú', this)" class="badge filter-tag" style="background:#b9f2ff; color:black;">DIA</span>
                    <button onclick="resetFilter()" class="btn-sub" style="margin-left:auto; padding:5px 10px; font-size:10px;">RESET ‚Ü∫</button>
                </div>
            </div>

            <div id="party-list"></div>
        </div>

        <div id="page-profile" class="page">
            <div class="box">
                <h3 style="color:var(--accent); font-family:'Black Han Sans';">// AGENT PROFILE</h3>
                <div id="avg-rating-area" style="background:#000; padding:20px; text-align:center; border: 1px dashed var(--accent); margin-bottom:20px; display:none;">
                    <p style="margin:0; font-size:11px; color:#555;">REPUTATION SCORE</p>
                    <div id="profile-avg-stars" style="font-size:32px; color:var(--accent); font-weight:900;"></div>
                </div>
                <label style="font-size:12px; color:#666;">BATTLE TAG</label>
                <input type="text" id="profile-btag" placeholder="BATTLETAG#1234">
                <button id="btn-save-profile" class="btn-main"><span>UPDATE PROFILE</span></button>
            </div>
        </div>

        <div id="page-noti" class="page">
            <h3 style="color:var(--accent); font-family:'Black Han Sans';">// COMMS LOG</h3>
            <div id="noti-list"></div>
            <div id="group-eval-list" style="margin-top:30px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="request-modal">
        <div class="box" style="width:340px; border:2px solid var(--accent); background:#111;">
            <h3 style="margin-top:0;">JOIN REQUEST</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <select id="request-pos"><option value="ÌÉ±Ïª§">TANK</option><option value="ÎîúÎü¨">DPS</option><option value="ÏßÄÏõê">SUP</option></select>
                <select id="request-tier"><option value="Í≥®Îìú">GOLD</option><option value="ÌîåÎûòÌã∞ÎÑò">PLAT</option><option value="Îã§Ïù¥ÏïÑÎ™¨Îìú">DIA</option></select>
            </div>
            <input type="text" id="request-btag" placeholder="MY BATTLETAG">
            <textarea id="request-msg" placeholder="MESSAGE TO LEADER" rows="3"></textarea>
            <button id="btn-confirm-send" class="btn-main"><span>SEND SIGNAL</span></button>
            <button class="btn-sub" onclick="closeModal()" style="width:100%; margin-top:10px;">ABORT</button>
        </div>
    </div>

    <div class="modal-overlay" id="rating-modal">
        <div class="box" style="width:340px; border:2px solid var(--accent); text-align:center;">
            <h3>MISSION DEBRIEF</h3>
            <p id="rating-target-name" style="font-weight:900; color:var(--accent);"></p>
            <div style="font-size:30px; margin:20px 0; display:flex; justify-content:center; gap:10px;">
                <span onclick="setRating(1)" class="star" style="cursor:pointer; color:#333;">‚òÖ</span>
                <span onclick="setRating(2)" class="star" style="cursor:pointer; color:#333;">‚òÖ</span>
                <span onclick="setRating(3)" class="star" style="cursor:pointer; color:#333;">‚òÖ</span>
                <span onclick="setRating(4)" class="star" style="cursor:pointer; color:#333;">‚òÖ</span>
                <span onclick="setRating(5)" class="star" style="cursor:pointer; color:#333;">‚òÖ</span>
            </div>
            <button id="btn-submit-rating" class="btn-main"><span>SUBMIT EVALUATION</span></button>
        </div>
    </div>

    <script>
        // UI Interaction
        const toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
            const overlay = document.getElementById('sidebar-overlay');
            overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
            document.getElementById('hamburger-btn').classList.toggle('active');
        };

        const showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            document.getElementById('sidebar-' + id).classList.add('active');
            if(id === 'noti') {
                document.getElementById('sidebar-new-tag').style.display = 'none';
                document.getElementById('nav-new-badge').style.display = 'none';
            }
        };

        const showPageAndClose = (id) => { showPage(id); toggleSidebar(); };
        const closeModal = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none');

        let tempRating = 0;
        const setRating = (n) => {
            tempRating = n;
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => s.style.color = i < n ? 'var(--accent)' : '#333');
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, getDoc, setDoc, deleteDoc, getDocs, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyA96CFg3o1TpD5lu-0rYMlIp16Ev8URDuw", 
            authDomain: "ow-party-97936.firebaseapp.com", 
            projectId: "ow-party-97936", 
            storageBucket: "ow-party-97936.firebasestorage.app", 
            messagingSenderId: "15782204013", 
            appId: "1:15782204013:web:5c74ef2e603c311fc82564" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        window.auth = auth;

        let currentPosts = [];
        let currentFilter = { pos: [], tier: [] };
        let myData = null;
        let selectedPostForRequest = null;
        let ratingTargetData = null;

        // --- AUTH & USER PRESENCE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                myData = userDoc.exists() ? userDoc.data() : { btag: "" };
                document.getElementById('display-btag').innerText = myData.btag || "UNREGISTERED";
                document.getElementById('profile-btag').value = myData.btag || "";
                document.getElementById('sidebar-user-tag').style.display = 'block';
                document.getElementById('login-form-sidebar').style.display = 'none';
                document.getElementById('user-info-sidebar').style.display = 'block';
                if(myData.ratingCount > 0) {
                    const avg = (myData.ratingTotal / myData.ratingCount).toFixed(1);
                    document.getElementById('avg-rating-area').style.display = 'block';
                    document.getElementById('profile-avg-stars').innerText = `‚òÖ ${avg}`;
                }
                listenNoti();
            } else {
                document.getElementById('sidebar-user-tag').style.display = 'none';
                document.getElementById('login-form-sidebar').style.display = 'block';
                document.getElementById('user-info-sidebar').style.display = 'none';
            }
        });

        // --- NOTIFICATIONS LISTENER ---
        const listenNoti = () => {
            const q = query(collection(db, "notifications"), where("toUid", "==", auth.currentUser.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('noti-list');
                const hasNew = snap.docs.some(d => !d.data().read);
                if(hasNew) {
                    document.getElementById('sidebar-new-tag').style.display = 'inline';
                    document.getElementById('nav-new-badge').style.display = 'block';
                }
                list.innerHTML = snap.docs.map(docSnap => {
                    const d = docSnap.data();
                    const id = docSnap.id;
                    return `
                    <div class="box" style="border-left-color: ${d.type==='match'?'var(--sup)':'var(--accent)'}; opacity: ${d.read?0.6:1}">
                        <p style="margin:0; font-size:13px;">${d.msg}</p>
                        ${d.type === 'request' && !d.handled ? `
                            <div style="margin-top:10px; display:flex; gap:5px;">
                                <button class="btn-main" style="height:35px; padding:0;" onclick="window.acceptMatch('${id}','${d.fromUid}','${d.postId}')"><span>ACCEPT</span></button>
                                <button class="btn-sub" style="height:35px; padding:0 15px;" onclick="window.rejectMatch('${id}')">DECLINE</button>
                            </div>
                        `:''}
                    </div>`;
                }).join('');
            });
        };

        // --- PARTY LIST & FILTERING ---
        const qParty = query(collection(db, "party"), orderBy("createdAt", "desc"));
        onSnapshot(qParty, (snap) => {
            currentPosts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            window.renderList();
        });

        window.renderList = () => {
            const listDiv = document.getElementById('party-list');
            const filtered = currentPosts.filter(p => {
                if (p.deleted) return false;
                if (currentFilter.pos.length > 0 && !currentFilter.pos.includes(p.pos)) return false;
                if (currentFilter.tier.length > 0 && !currentFilter.tier.includes(p.tier)) return false;
                return true;
            });

            listDiv.innerHTML = filtered.map(p => {
                const isMyPost = auth.currentUser && p.uid === auth.currentUser.uid;
                const posColor = p.pos === 'ÏßÄÏõê' ? 'var(--sup)' : (p.pos === 'ÌÉ±Ïª§' ? 'var(--tank)' : 'var(--dps)');
                const avgRating = p.ownerRate ? p.ownerRate.toFixed(1) : "NEW";

                return `
                <div class="box">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:900; font-size:18px; color:white;">
                                ${p.btag.split('#')[0]} <span style="color:var(--accent); font-size:12px; margin-left:5px;">‚òÖ ${avgRating}</span>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <span class="pos-badge-inline" style="background:${posColor}; color:${p.pos==='ÏßÄÏõê'?'black':'white'};"><span>${p.pos}</span></span>
                                <span style="font-weight:900; font-size:14px; color:#aaa; transform:var(--owcs-skew); padding-top:4px;">${p.tier} ${p.tier==='Î∞∞Ïπò'?'':p.tierNum}</span>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#555; margin-bottom:5px;">${p.slots || 0}/${p.maxp} AGENTS</div>
                            ${isMyPost ? 
                                `<button class="btn-sub" style="color:#ff3c3c; border-color:#ff3c3c;" onclick="window.delPost('${p.id}')">CLOSE</button>` : 
                                `<button class="btn-main" style="width:80px; margin:0;" onclick="window.openRequestModal('${p.uid}','${p.btag}','${p.id}')"><span>JOIN</span></button>`
                            }
                        </div>
                    </div>
                    <p style="background:#000; padding:12px; font-size:13px; color:#bbb; border-left:2px solid var(--accent); margin-top:15px; white-space:pre-wrap;">${p.desc}</p>
                </div>`;
            }).join('');
        };

        // --- ACTIONS ---
        document.getElementById('btn-post').onclick = async () => {
            if (!auth.currentUser) return alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.");
            const btag = document.getElementById('post-btag').value.trim();
            const pos = document.getElementById('post-main-pos').value;
            const tier = document.getElementById('post-tier').value;
            const tierNum = document.getElementById('post-tier-num').value;
            const maxp = document.getElementById('post-maxp').value;
            const desc = document.getElementById('post-desc').value.trim();

            if(!btag || !desc) return alert("Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
            const ownerRate = myData.ratingCount > 0 ? (myData.ratingTotal / myData.ratingCount) : 0;

            await addDoc(collection(db, "party"), {
                uid: auth.currentUser.uid, btag, pos, tier, tierNum, maxp: Number(maxp), desc,
                createdAt: Date.now(), slots: 1, ownerRate, deleted: false
            });
            alert("ÌååÌã∞ Î™®ÏßëÏùÑ ÏãúÏûëÌï©ÎãàÎã§!");
        };

        window.openRequestModal = (targetUid, targetBtag, postId) => {
            if(!auth.currentUser) return alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            if(auth.currentUser.uid === targetUid) return alert("Î≥∏Ïù∏Ïùò ÌååÌã∞ÏûÖÎãàÎã§.");
            selectedPostForRequest = { targetUid, targetBtag, postId };
            document.getElementById('request-btag').value = myData.btag || "";
            document.getElementById('request-modal').style.display = 'flex';
        };

        document.getElementById('btn-confirm-send').onclick = async () => {
            const pos = document.getElementById('request-pos').value;
            const tier = document.getElementById('request-tier').value;
            const btag = document.getElementById('request-btag').value.trim();
            const msg = document.getElementById('request-msg').value.trim();

            await addDoc(collection(db, "notifications"), {
                toUid: selectedPostForRequest.targetUid, fromUid: auth.currentUser.uid,
                postId: selectedPostForRequest.postId, type: 'request',
                msg: `[Ïã†Ï≤≠] ${btag}ÎãòÏù¥ ÌååÌã∞ Ï∞∏Ïó¨Î•º ÏõêÌï©ÎãàÎã§: "${msg}"`,
                createdAt: Date.now(), read: false, handled: false
            });
            alert("Ïã†Ï≤≠Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.");
            closeModal();
        };

        window.acceptMatch = async (notiId, fromUid, postId) => {
            const pRef = doc(db, "party", postId);
            const pSnap = await getDoc(pRef);
            if(pSnap.data().slots >= pSnap.data().maxp) return alert("Ïù¥ÎØ∏ ÌååÌã∞Í∞Ä Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.");

            await updateDoc(pRef, { slots: pSnap.data().slots + 1 });
            await updateDoc(doc(db, "notifications"), { handled: true, read: true });
            
            await addDoc(collection(db, "notifications"), {
                toUid: fromUid, fromUid: auth.currentUser.uid, type: 'match',
                msg: `[ÏäπÏù∏] ÌååÌã∞Ïû•Ïù¥ Ïã†Ï≤≠ÏùÑ ÏäπÏù∏ÌñàÏäµÎãàÎã§! Î∞∞ÌãÄÌÉúÍ∑∏: ${pSnap.data().btag}`,
                createdAt: Date.now(), read: false,
                partyId: postId, targetBtag: pSnap.data().btag
            });
            alert("Ï∞∏Ïó¨Î•º ÏäπÏù∏ÌñàÏäµÎãàÎã§.");
        };

        window.delPost = async (id) => {
            if(!confirm("Î™®ÏßëÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Ï∞∏Ïó¨ÏûêÎì§ÏóêÍ≤å ÌèâÍ∞Ä ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°Îê©ÎãàÎã§)")) return;
            // 1. Ï∞∏Ïó¨ÏûêÎì§ÏóêÍ≤å ÌèâÍ∞Ä ÏïåÎ¶º ÏÉùÏÑ±
            const notis = await getDocs(query(collection(db, "notifications"), where("postId", "==", id), where("type", "==", "match")));
            const batch = writeBatch(db);
            notis.docs.forEach(d => {
                batch.set(doc(collection(db, "notifications")), {
                    toUid: d.data().toUid, type: 'rating',
                    msg: `ÌååÌã∞Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. ÌååÌã∞Ïû•(${myData.btag})ÏùÑ ÌèâÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî!`,
                    targetUid: auth.currentUser.uid, targetBtag: myData.btag, createdAt: Date.now(), read: false
                });
            });
            batch.update(doc(db, "party", id), { deleted: true });
            await batch.commit();
        };

        // --- RATING LOGIC ---
        onSnapshot(query(collection(db, "notifications"), where("toUid", "==", auth.currentUser?.uid || "none"), where("type", "==", "rating")), (snap) => {
            const list = document.getElementById('group-eval-list');
            list.innerHTML = snap.docs.map(docSnap => {
                const d = docSnap.data();
                if(d.done) return "";
                return `
                <div class="box" style="border: 1px solid var(--accent); background: #000;">
                    <p style="font-weight:900;">${d.msg}</p>
                    <button class="btn-main" onclick="window.openRatingModal('${docSnap.id}', '${d.targetUid}', '${d.targetBtag}')"><span>EVALUATE</span></button>
                </div>`;
            }).join('');
        });

        window.openRatingModal = (notiId, targetUid, targetBtag) => {
            ratingTargetData = { notiId, targetUid, targetBtag };
            document.getElementById('rating-target-name').innerText = targetBtag;
            document.getElementById('rating-modal').style.display = 'flex';
        };

        document.getElementById('btn-submit-rating').onclick = async () => {
            if(tempRating === 0) return alert("Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            const tRef = doc(db, "users", ratingTargetData.targetUid);
            const tSnap = await getDoc(tRef);
            const current = tSnap.exists() ? tSnap.data() : { ratingTotal: 0, ratingCount: 0 };
            
            await setDoc(tRef, {
                ratingTotal: (current.ratingTotal || 0) + tempRating,
                ratingCount: (current.ratingCount || 0) + 1
            }, { merge: true });

            await updateDoc(doc(db, "notifications", ratingTargetData.notiId), { done: true, read: true });
            alert("ÌèâÍ∞ÄÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
            closeModal();
        };

        // --- AUTH: LOGIN / LOGOUT ---
        document.getElementById('btn-login').onclick = async () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert("Î∞òÍ∞ëÏäµÎãàÎã§!");
            } catch (e) {
                if(confirm("Í≥ÑÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§. ÏÉàÎ°ú ÏÉùÏÑ±Ìï†ÍπåÏöî?")) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    alert("Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!");
                }
            }
        };

        document.getElementById('btn-logout').onclick = () => { signOut(auth); location.reload(); };

        document.getElementById('btn-save-profile').onclick = async () => {
            const btag = document.getElementById('profile-btag').value.trim();
            await setDoc(doc(db, "users", auth.currentUser.uid), { btag }, { merge: true });
            alert("ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
        };

        // --- FILTERS ---
        window.toggleFilter = (type, val, el) => {
            const arr = currentFilter[type];
            if(arr.includes(val)) {
                currentFilter[type] = arr.filter(v => v !== val);
                el.classList.remove('active');
            } else {
                arr.push(val);
                el.classList.add('active');
            }
            window.renderList();
        };
        window.resetFilter = () => {
            currentFilter = { pos: [], tier: [] };
            document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
            window.renderList();
        };

        // --- PRESENCE SYSTEM ---
        const updatePresence = async () => {
            if(!auth.currentUser) return;
            await setDoc(doc(db, "presences", auth.currentUser.uid), {
                lastSeen: Date.now()
            }, { merge: true });
        };
        setInterval(updatePresence, 60000);

        onSnapshot(collection(db, "presences"), (snap) => {
            const now = Date.now();
            let count = 0;
            snap.docs.forEach(d => { if(now - d.data().lastSeen < 120000) count++; });
            const partyCount = currentPosts.filter(p => !p.deleted).length;
            document.getElementById('live-user-count').innerText = `LIVE AGENTS: ${count + 3 + (partyCount*2)}`;
            document.getElementById('live-party-count').innerText = `MISSIONS IN PROGRESS: ${partyCount}`;
        });

    </script>
</body>
</html>
