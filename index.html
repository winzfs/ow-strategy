<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì˜¤ë²„ì›Œì¹˜ ì „ëµ ë³´ë“œ - ì•ˆì •í™” ë²„ì „</title>
    <style>
        :root { --sidebar-width: 260px; --accent-color: #ff9c00; --ally-color: #00a2ff; --enemy-color: #ff3c3c; }
        body { margin: 0; display: flex; height: 100vh; overflow: hidden; font-family: sans-serif; background: #111; color: white; }
        
        #sidebar { width: var(--sidebar-width); background: #222; overflow-y: auto; padding: 15px; border-right: 1px solid #444; z-index: 100; transition: 0.3s; }
        #sidebar.hidden { transform: translateX(-100%); position: absolute; height: 100%; }
        
        .controls { position: absolute; right: 15px; top: 15px; z-index: 101; display: flex; flex-direction: column; gap: 8px; }
        .tool-group { background: rgba(0,0,0,0.85); padding: 8px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; border: 1px solid #555; }
        .tool-btn { background: #333; color: white; border: 1px solid #555; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 13px; }
        .tool-btn.active { border-color: white; background: #555; }
        .btn-ally.active { background: var(--ally-color) !important; }
        .btn-enemy.active { background: var(--enemy-color) !important; }

        .hero-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px; }
        .hero-item { aspect-ratio: 1/1; background: #333; border-radius: 4px; overflow: hidden; cursor: pointer; }
        .hero-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        #viewport { flex-grow: 1; position: relative; overflow: hidden; background: #000; touch-action: none; cursor: grab; }
        #viewport:active { cursor: grabbing; }
        #map-container { position: absolute; transform-origin: 0 0; will-change: transform; pointer-events: none; }
        #map-image { display: block; user-select: none; -webkit-user-drag: none; }
        
        #hero-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .placed-hero { position: absolute; width: 50px; height: 50px; pointer-events: auto; cursor: move; transform: translate(-50%, -50%); border-radius: 50%; border: 3px solid white; background: #222; overflow: hidden; z-index: 10; }
        .placed-hero.selected { box-shadow: 0 0 15px white; border-color: #fff !important; z-index: 11; }
        .placed-hero img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .hero-delete-btn { position: absolute; top: -5px; right: -5px; background: #f44; color: white; border: 1px solid white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 12; }
        .selected .hero-delete-btn { display: flex; }

        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #drawing-canvas { z-index: 20; }
        #temp-canvas { z-index: 21; }

        #toggle-btn { position: absolute; left: 15px; top: 15px; z-index: 101; padding: 10px; background: var(--accent-color); border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<button id="toggle-btn">HEROES</button>

<div class="controls">
    <div class="tool-group">
        <button class="tool-btn active" id="btn-move">âœ‹ ì´ë™ ëª¨ë“œ</button>
    </div>
    <div class="tool-group">
        <button class="tool-btn btn-ally active" id="color-ally">ğŸ”µ ì•„êµ°</button>
        <button class="tool-btn btn-enemy" id="color-enemy">ğŸ”´ ì êµ°</button>
    </div>
    <div class="tool-group">
        <button class="tool-btn" id="tool-pen">âœï¸ íœ</button>
        <button class="tool-btn" id="tool-arrow">ğŸ¹ í™”ì‚´í‘œ</button>
    </div>
    <div class="tool-group">
        <button class="tool-btn" id="btn-undo">â†©ï¸ ì·¨ì†Œ</button>
        <button class="tool-btn" id="btn-clear" style="color:#f66;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="sidebar">
    <div style="height: 50px;"></div>
    <div id="hero-categories"></div>
</div>

<div id="viewport">
    <div id="map-container">
        <img id="map-image" src="Lijiang_Tower_Top_Down_View.jpg">
        <div id="hero-layer"></div>
        <canvas id="drawing-canvas"></canvas>
        <canvas id="temp-canvas"></canvas>
    </div>
</div>

<script>
    const viewport = document.getElementById('viewport');
    const mapContainer = document.getElementById('map-container');
    const heroLayer = document.getElementById('hero-layer');
    const canvas = document.getElementById('drawing-canvas');
    const tempCanvas = document.getElementById('temp-canvas');
    const ctx = canvas.getContext('2d');
    const tctx = tempCanvas.getContext('2d');
    const mapImg = document.getElementById('map-image');

    let scale = 0.5, translateX = 100, translateY = 100;
    let isDraggingMap = false, isDraggingHero = false, isDrawing = false;
    let startX, startY, activeHero = null, heroOffsetX, heroOffsetY;
    let currentTool = 'move', currentTeamColor = '#00a2ff', drawStartPos = null;
    let history = [];

    mapImg.onload = () => {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = tempCanvas.width = mapImg.naturalWidth * dpr;
        canvas.height = tempCanvas.height = mapImg.naturalHeight * dpr;
        canvas.style.width = tempCanvas.style.width = mapImg.naturalWidth + 'px';
        canvas.style.height = tempCanvas.style.height = mapImg.naturalHeight + 'px';
        ctx.scale(dpr, dpr); tctx.scale(dpr, dpr);
        saveState(); update();
    };

    function update() {
        mapContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function saveState() {
        history.push(canvas.toDataURL());
        if (history.length > 20) history.shift();
    }

    // ì¢Œí‘œ ë³€í™˜ ìœ í‹¸ë¦¬í‹°: í™”ë©´ ì¢Œí‘œ -> ë§µ ë‚´ë¶€ ì¢Œí‘œ
    function getMapCoords(clientX, clientY) {
        const rect = viewport.getBoundingClientRect();
        return {
            x: (clientX - rect.left - translateX) / scale,
            y: (clientY - rect.top - translateY) / scale
        };
    }

    // --- UI ì´ë²¤íŠ¸ ì²˜ë¦¬ ---
    document.getElementById('btn-move').onclick = () => { currentTool = 'move'; updateToolUI('btn-move'); };
    document.getElementById('tool-pen').onclick = () => { currentTool = 'pen'; updateToolUI('tool-pen'); };
    document.getElementById('tool-arrow').onclick = () => { currentTool = 'arrow'; updateToolUI('tool-arrow'); };
    document.getElementById('color-ally').onclick = () => { currentTeamColor = '#00a2ff'; updateColorUI('color-ally'); };
    document.getElementById('color-enemy').onclick = () => { currentTeamColor = '#ff3c3c'; updateColorUI('color-enemy'); };

    function updateToolUI(id) {
        ['btn-move', 'tool-pen', 'tool-arrow'].forEach(bid => document.getElementById(bid).classList.toggle('active', bid === id));
    }
    function updateColorUI(id) {
        ['color-ally', 'color-enemy'].forEach(bid => document.getElementById(bid).classList.toggle('active', bid === id));
    }

    document.getElementById('btn-undo').onclick = () => {
        if (history.length <= 1) return;
        history.pop();
        const img = new Image();
        img.src = history[history.length - 1];
        img.onload = () => {
            const dpr = window.devicePixelRatio || 1;
            ctx.clearRect(0, 0, canvas.width/dpr, canvas.height/dpr);
            ctx.drawImage(img, 0, 0, canvas.width/dpr, canvas.height/dpr);
        };
    };

    document.getElementById('btn-clear').onclick = () => {
        if(confirm('ì „ì²´ ì´ˆê¸°í™”?')) { ctx.clearRect(0,0,canvas.width,canvas.height); heroLayer.innerHTML = ''; saveState(); }
    };

    // --- í†µí•© ì¸í„°ë™ì…˜ (í™•ëŒ€/ì¶•ì†Œ, ë“œë˜ê·¸, ê·¸ë¦¬ê¸°) ---
    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = viewport.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        
        const mapP = getMapCoords(e.clientX, e.clientY);
        const delta = e.deltaY < 0 ? 1.1 : 0.9;
        const nextScale = Math.min(Math.max(0.1, scale * delta), 5);

        translateX = mx - mapP.x * nextScale;
        translateY = my - mapP.y * nextScale;
        scale = nextScale;
        update();
    }, { passive: false });

    viewport.onmousedown = (e) => {
        const target = e.target;
        const coords = getMapCoords(e.clientX, e.clientY);

        if (target.closest('.placed-hero')) {
            // 1. ì˜ì›… ë“œë˜ê·¸ ì‹œì‘
            isDraggingHero = true;
            activeHero = target.closest('.placed-hero');
            if(activeHero.classList.contains('selected')) {
                // ì´ë¯¸ ì„ íƒëœ ìƒíƒœì—ì„œ ëˆ„ë¥¸ ê²½ìš° ì˜¤í”„ì…‹ ê³„ì‚°
                heroOffsetX = coords.x - parseFloat(activeHero.style.left);
                heroOffsetY = coords.y - parseFloat(activeHero.style.top);
            } else {
                // ì²˜ìŒ ì„ íƒ ì‹œ
                document.querySelectorAll('.placed-hero').forEach(h => h.classList.remove('selected'));
                activeHero.classList.add('selected');
                heroOffsetX = coords.x - parseFloat(activeHero.style.left);
                heroOffsetY = coords.y - parseFloat(activeHero.style.top);
            }
        } else if (currentTool === 'move') {
            // 2. ë§µ ë“œë˜ê·¸ ì‹œì‘
            isDraggingMap = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            document.querySelectorAll('.placed-hero').forEach(h => h.classList.remove('selected'));
        } else {
            // 3. ê·¸ë¦¬ê¸° ì‹œì‘
            isDrawing = true;
            drawStartPos = coords;
            ctx.strokeStyle = tctx.strokeStyle = currentTeamColor;
            ctx.lineWidth = tctx.lineWidth = 5 / scale;
            ctx.lineCap = 'round';
            if(currentTool === 'pen') { ctx.beginPath(); ctx.moveTo(coords.x, coords.y); }
        }
    };

    window.onmousemove = (e) => {
        const coords = getMapCoords(e.clientX, e.clientY);

        if (isDraggingHero && activeHero) {
            activeHero.style.left = (coords.x - heroOffsetX) + 'px';
            activeHero.style.top = (coords.y - heroOffsetY) + 'px';
        } else if (isDraggingMap) {
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            update();
        } else if (isDrawing) {
            if(currentTool === 'pen') { ctx.lineTo(coords.x, coords.y); ctx.stroke(); }
            else if(currentTool === 'arrow') {
                tctx.clearRect(0,0,20000, 20000); // ë„‰ë„‰í•˜ê²Œ ì§€ì›€
                drawArrow(tctx, drawStartPos.x, drawStartPos.y, coords.x, coords.y);
            }
        }
    };

    window.onmouseup = (e) => {
        if (isDrawing && currentTool === 'arrow') {
            const coords = getMapCoords(e.clientX, e.clientY);
            drawArrow(ctx, drawStartPos.x, drawStartPos.y, coords.x, coords.y);
            tctx.clearRect(0,0,20000, 20000);
        }
        if(isDrawing) saveState();
        isDraggingMap = isDraggingHero = isDrawing = false;
        activeHero = null;
    };

    function drawArrow(t, fx, fy, tx, ty) {
        const headlen = 15 / scale;
        const angle = Math.atan2(ty - fy, tx - fx);
        t.beginPath();
        t.moveTo(fx, fy); t.lineTo(tx, ty);
        t.lineTo(tx - headlen * Math.cos(angle - Math.PI / 6), ty - headlen * Math.sin(angle - Math.PI / 6));
        t.moveTo(tx, ty);
        t.lineTo(tx - headlen * Math.cos(angle + Math.PI / 6), ty - headlen * Math.sin(angle + Math.PI / 6));
        t.stroke();
    }

     // --- ì˜ì›… ë¦¬ìŠ¤íŠ¸ ìƒì„± --- // --- ì˜ì›… ë¦¬ìŠ¤íŠ¸ ìƒì„± ---
    const heroData = {
        "TANK": ["dva", "doomfist", "ramattra", "reinhardt", "wrecking-ball", "roadhog", "mauga", "sigma", "winston", "zarya", "junker-queen"],
        "DPS": ["genji", "reaper", "mei", "bastion", "sojourn", "soldier-76", "sombra", "symmetra", "ashe", "echo", "widowmaker", "junkrat", "cassidy", "torbjorn", "tracer", "pharah", "venture"],
        "SUP": ["lifeweaver", "lucio", "baptiste", "brigitte", "ana", "illari", "zenyatta", "kiriko", "moira"]
    };

    Object.entries(heroData).forEach(([role, list]) => {
        const cat = document.createElement('div');
        cat.innerHTML = `<p style="color:var(--accent-color); font-weight:bold; font-size:11px; margin:5px 0;">${role}</p>`;
        const grid = document.createElement('div');
        grid.className = 'hero-list';
        list.forEach(id => {
            const item = document.createElement('div');
            item.className = 'hero-item';
            item.innerHTML = `<img src="https://d1u1mce87gyfbn.cloudfront.net/hero/${id}/icon-portrait.png">`;
            item.onclick = (e) => { e.stopPropagation(); createHero(id); };
            grid.appendChild(item);
        });
        cat.appendChild(grid);
        document.getElementById('hero-categories').appendChild(cat);
    });

    function createHero(id) {
        const div = document.createElement('div');
        div.className = 'placed-hero';
        div.style.borderColor = currentTeamColor;
        
          // ë·°í¬íŠ¸ ì¤‘ì•™ì— ìƒì„± // ë·°í¬íŠ¸ ì¤‘ì•™ì— ìƒì„± // ë·°í¬íŠ¸ ì¤‘ì•™ì— ìƒì„±  
        const center = getMapCoords(viewport.offsetWidth/2 + viewport.offsetLeft, viewport.offsetHeight/2 + viewport.offsetTop);
        div.style.left = center.x + 'px'; div.style.top = center.y + 'px';
        div.innerHTML = `<img src="https://d1u1mce87gyfbn.cloudfront.net/hero/${id}/icon-portrait.png"><button class="hero-delete-btn">âœ•</button>`;
        
        div.querySelector('.hero-delete-btn').onclick = (e) => { e.stopPropagation(); div.remove(); };
        heroLayer.appendChild(div);
    }

    document.getElementById('toggle-btn').onclick = () => document.getElementById('sidebar').classList.toggle('hidden');
</script>
</body>
</html>
