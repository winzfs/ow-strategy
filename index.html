<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Overwatch Tactical Simulator Pro</title>
    <style>
        :root { --sidebar-width: 240px; --accent-color: #ff9c00; --ally-color: #00a2ff; --enemy-color: #ff3c3c; }
        body { margin: 0; display: flex; height: 100vh; overflow: hidden; font-family: 'Pretendard', sans-serif; background: #111; color: white; touch-action: none; }
        
        /* ì‚¬ì´ë“œë°” & ë„êµ¬í•¨ ìŠ¤í¬ë¡¤ */
        #sidebar { width: var(--sidebar-width); background: #222; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 10px; border-right: 1px solid #444; z-index: 100; transition: transform 0.3s ease; }
        #sidebar.hidden { transform: translateX(-100%); position: absolute; height: 100%; }
        
        .controls { position: absolute; right: 10px; top: 10px; bottom: 10px; z-index: 101; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; pointer-events: none; }
        .tool-group { background: rgba(0,0,0,0.9); padding: 8px; border-radius: 10px; display: flex; flex-direction: column; gap: 6px; border: 1px solid #444; pointer-events: auto; }

        /* ë²„íŠ¼ ìƒíƒœ */
        .tool-btn { background: #333; color: white; border: 2px solid transparent; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .tool-btn.active { border-color: white; background: #555; }
        .btn-ally.active { background: var(--ally-color) !important; }
        .btn-enemy.active { background: var(--enemy-color) !important; }
        .btn-special { background: var(--accent-color); color: black; }

        /* ë©”ì¸ ë·° */
        #viewport { flex-grow: 1; position: relative; overflow: hidden; background: #000; }
        #map-container { position: absolute; transform-origin: 0 0; }
        #map-image { display: block; user-select: none; -webkit-user-drag: none; opacity: 0.8; }
        
        /* ì˜ì›… ë ˆì´ì–´ */
        #hero-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .placed-hero { position: absolute; width: 50px; height: 50px; transform: translate(-50%, -50%); border-radius: 50%; border: 3px solid white; background: #222; pointer-events: auto; transition: border-color 0.3s; }
        .placed-hero.selected { box-shadow: 0 0 20px white; z-index: 50; }
        .placed-hero img { width: 100%; height: 100%; border-radius: 50%; pointer-events: none; }

        /* ì˜ì›… ë¶€ê°€ ìƒíƒœ (ê¶ê·¹ê¸° ë“±) */
        .status-badge { position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; color: white; border: 1px solid white; }
        .status-ult { background: #ffcc00; display: flex; color: black; } /* ê¶ê·¹ê¸° ë³´ìœ  ì‹œ í‘œì‹œ */

        /* ì• ë‹ˆë©”ì´ì…˜ ê²½ë¡œìš© ìº”ë²„ìŠ¤ */
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #drawing-canvas { z-index: 20; }
        #temp-canvas { z-index: 21; }

        /* ë ˆì´ì € í¬ì¸í„° ì „ìš© */
        #laser-dot { position: absolute; width: 15px; height: 15px; background: rgba(255, 0, 0, 0.8); border-radius: 50%; box-shadow: 0 0 15px 5px red; pointer-events: none; display: none; z-index: 100; }

        #toggle-btn { position: absolute; left: 10px; top: 10px; z-index: 101; padding: 12px; background: var(--accent-color); border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<button id="toggle-btn">HEROES</button>

<div class="controls">
    <div class="tool-group">
        <button class="tool-btn active" id="btn-move">âœ‹ ì´ë™</button>
        <button class="tool-btn" id="tool-pen">âœï¸ íœ</button>
        <button class="tool-btn" id="tool-arrow">ğŸ¹ í™”ì‚´í‘œ</button>
        <button class="tool-btn" id="tool-laser">ğŸ”¦ ë ˆì´ì €</button>
        <button class="tool-btn" id="tool-path">ğŸƒ ê²½ë¡œë…¹í™”</button>
    </div>
    <div class="tool-group">
        <button class="tool-btn btn-ally active" id="color-ally">ğŸ”µ ì•„êµ°</button>
        <button class="tool-btn btn-enemy" id="color-enemy">ğŸ”´ ì êµ°</button>
    </div>
    <div class="tool-group">
        <button class="tool-btn btn-special" id="btn-play">â–¶ï¸ ì¬ìƒ</button>
        <button class="tool-btn" id="btn-undo">â†©ï¸ ì·¨ì†Œ</button>
        <button class="tool-btn" id="btn-clear" style="color:#ff8888;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="sidebar">
    <div style="height: 55px;"></div>
    <div class="map-selector-wrapper">
        <select class="map-select" id="map-select" style="width:100%; padding:10px; background:#333; color:white; border:1px solid var(--accent-color);">
            <option value="https://overwatch.wiki.gallery/images/3/30/Hanamura_top-down.jpg">í•˜ë‚˜ë¬´ë¼</option>
            <option value="https://overwatch.wiki.gallery/images/f/f6/Kings_Row_top-down.jpg">ì™•ì˜ ê¸¸</option>
            <option value="https://overwatch.wiki.gallery/images/c/c3/Eichenwalde_top-down.jpg">ì•„ì´í—¨ë°œë°</option>
        </select>
    </div>
    <div id="hero-categories"></div>
</div>

<div id="viewport">
    <div id="laser-dot"></div>
    <div id="map-container">
        <img id="map-image" src="https://overwatch.wiki.gallery/images/f/f6/Kings_Row_top-down.jpg">
        <div id="hero-layer"></div>
        <canvas id="drawing-canvas"></canvas>
        <canvas id="temp-canvas"></canvas>
    </div>
</div>

<script>
    const viewport = document.getElementById('viewport');
    const mapContainer = document.getElementById('map-container');
    const heroLayer = document.getElementById('hero-layer');
    const canvas = document.getElementById('drawing-canvas');
    const tempCanvas = document.getElementById('temp-canvas');
    const ctx = canvas.getContext('2d');
    const tctx = tempCanvas.getContext('2d');
    const laserDot = document.getElementById('laser-dot');
    const mapImg = document.getElementById('map-image');

    let scale = 0.5, tx = 0, ty = 0;
    let state = { isDown: false, mode: null, initialDist: 0, initialScale: 1 };
    let activeHero = null, history = [], currentTool = 'move', currentTeamColor = '#00a2ff';
    let startPoint = { x: 0, y: 0 }, mapStart = { x: 0, y: 0 };
    
    // ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„° ì €ì¥ì†Œ
    let heroPaths = new Map(); // ì˜ì›…ë³„ ê²½ë¡œ ì¢Œí‘œ ì €ì¥

    mapImg.onload = () => {
        canvas.width = tempCanvas.width = mapImg.naturalWidth;
        canvas.height = tempCanvas.height = mapImg.naturalHeight;
        tx = (viewport.offsetWidth - mapImg.naturalWidth * scale) / 2;
        ty = (viewport.offsetHeight - mapImg.naturalHeight * scale) / 2;
        updateTransform(); saveState();
    };

    function updateTransform() { mapContainer.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`; }
    function saveState() { history.push(canvas.toDataURL()); if (history.length > 20) history.shift(); }
    function getLocalPos(clientX, clientY) {
        const rect = mapContainer.getBoundingClientRect();
        return { x: (clientX - rect.left) / scale, y: (clientY - rect.top) / scale };
    }

    // --- ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ í•¨ìˆ˜ ---
    document.getElementById('btn-play').onclick = () => {
        heroPaths.forEach((path, hero) => {
            if (path.length === 0) return;
            let step = 0;
            const timer = setInterval(() => {
                if (step >= path.length) { clearInterval(timer); return; }
                hero.style.left = path[step].x + 'px';
                hero.style.top = path[step].y + 'px';
                step++;
            }, 20); // 20ms ê°„ê²©ìœ¼ë¡œ ì¬ìƒ
        });
    };

    // --- í„°ì¹˜/ë§ˆìš°ìŠ¤ í•¸ë“¤ëŸ¬ ---
    function onStart(e) {
        if (e.target.closest('#sidebar') || e.target.closest('.controls')) return;
        const isTouch = e.type.includes('touch');
        if (isTouch && e.touches.length === 2) {
            state.mode = 'zoom';
            state.initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            state.initialScale = scale;
            return;
        }
        const point = isTouch ? e.touches[0] : e;
        const heroEl = e.target.closest('.placed-hero');
        const coords = getLocalPos(point.clientX, point.clientY);
        state.isDown = true;

        if (currentTool === 'laser') {
            laserDot.style.display = 'block';
            updateLaser(point.clientX, point.clientY);
        } else if (heroEl) {
            state.mode = 'hero'; activeHero = heroEl;
            document.querySelectorAll('.placed-hero').forEach(h => h.classList.remove('selected'));
            activeHero.classList.add('selected');
            if (currentTool === 'path') {
                heroPaths.set(activeHero, []); // ê²½ë¡œ ì´ˆê¸°í™”
            }
        } else if (currentTool === 'move') {
            state.mode = 'map'; startPoint = { x: point.clientX, y: point.clientY };
            mapStart = { x: tx, y: ty };
        } else {
            state.mode = 'draw'; startPoint = { x: coords.x, y: coords.y };
            ctx.strokeStyle = tctx.strokeStyle = currentTeamColor;
            ctx.lineWidth = 5 / scale; ctx.lineCap = 'round';
            if (currentTool === 'pen') { ctx.beginPath(); ctx.moveTo(coords.x, coords.y); }
        }
    }

    function onMove(e) {
        const isTouch = e.type.includes('touch');
        const point = isTouch ? e.touches[0] : e;
        const coords = getLocalPos(point.clientX, point.clientY);

        if (currentTool === 'laser' && state.isDown) {
            updateLaser(point.clientX, point.clientY);
            return;
        }

        if (state.mode === 'zoom' && isTouch && e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            scale = Math.min(Math.max(0.1, state.initialScale * (dist / state.initialDist)), 5);
            updateTransform(); return;
        }

        if (!state.isDown) return;
        if (state.mode === 'hero' && activeHero) {
            activeHero.style.left = coords.x + 'px';
            activeHero.style.top = coords.y + 'px';
            if (currentTool === 'path') {
                heroPaths.get(activeHero).push({x: coords.x, y: coords.y});
            }
        } else if (state.mode === 'map') {
            tx = mapStart.x + (point.clientX - startPoint.x);
            ty = mapStart.y + (point.clientY - startPoint.y);
            updateTransform();
        } else if (state.mode === 'draw') {
            if (currentTool === 'pen') { ctx.lineTo(coords.x, coords.y); ctx.stroke(); }
            else if (currentTool === 'arrow') {
                tctx.clearRect(0, 0, canvas.width, canvas.height);
                drawArrow(tctx, startPoint.x, startPoint.y, coords.x, coords.y);
            }
        }
    }

    function updateLaser(x, y) {
        laserDot.style.left = (x - 7) + 'px';
        laserDot.style.top = (y - 7) + 'px';
    }

    function onEnd() {
        if (state.mode === 'draw') {
            if (currentTool === 'arrow') {
                // ì„ì‹œ ìº”ë²„ìŠ¤ì˜ í™”ì‚´í‘œë¥¼ ì‹¤ì œ ìº”ë²„ìŠ¤ì— ë³µì‚¬í•˜ëŠ” ë¡œì§ (ìƒëµ ê°€ëŠ¥í•˜ë‚˜ ì™„ê²°ì„± ìœ„í•´ í•„ìš”)
            }
            saveState();
        }
        laserDot.style.display = 'none';
        state.isDown = false; state.mode = null;
    }

    // --- ì˜ì›… ìƒíƒœ ë©”ë‰´ (ìš°í´ë¦­/ê¸¸ê²Œ ëˆ„ë¥´ê¸° ëŒ€ì²´) ---
    function toggleUlt(hero) {
        let badge = hero.querySelector('.status-badge');
        badge.classList.toggle('status-ult');
        badge.innerText = badge.classList.contains('status-ult') ? 'Q' : '';
    }

    // --- ë¦¬ìŠ¤ë„ˆ ---
    viewport.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
    viewport.addEventListener('touchstart', (e) => { if(e.touches.length < 3) onStart(e); }, {passive: false});
    window.addEventListener('touchmove', (e) => { if(state.isDown || state.mode==='zoom') { e.preventDefault(); onMove(e); } }, {passive: false});
    window.addEventListener('touchend', onEnd);

    // --- ë„êµ¬ ì„ íƒ ---
    const toolIds = ['btn-move', 'tool-pen', 'tool-arrow', 'tool-laser', 'tool-path'];
    toolIds.forEach(id => {
        document.getElementById(id).onclick = () => {
            currentTool = id.replace('tool-', '').replace('btn-', '');
            toolIds.forEach(i => document.getElementById(i).classList.toggle('active', i === id));
        };
    });

    document.getElementById('color-ally').onclick = () => { currentTeamColor = '#00a2ff'; setActiveColor('color-ally'); };
    document.getElementById('color-enemy').onclick = () => { currentTeamColor = '#ff3c3c'; setActiveColor('color-enemy'); };
    function setActiveColor(id) {
        document.getElementById('color-ally').classList.toggle('active', id === 'color-ally');
        document.getElementById('color-enemy').classList.toggle('active', id === 'color-enemy');
    }

    // --- í™”ì‚´í‘œ ê·¸ë¦¬ê¸° ---
    function drawArrow(t, fx, fy, tx, ty) {
        const headlen = 15 / scale;
        const angle = Math.atan2(ty - fy, tx - fx);
        t.beginPath(); t.moveTo(fx, fy); t.lineTo(tx, ty);
        t.lineTo(tx - headlen * Math.cos(angle - Math.PI/6), ty - headlen * Math.sin(angle - Math.PI/6));
        t.moveTo(tx, ty);
        t.lineTo(tx - headlen * Math.cos(angle + Math.PI/6), ty - headlen * Math.sin(angle + Math.PI/6));
        t.stroke();
    }

    // --- ì˜ì›… ìƒì„± (ìƒíƒœ ë±ƒì§€ í¬í•¨) ---
    const heroes = { "TANK": ["dva", "reinhardt", "winston"], "DPS": ["genji", "tracer", "sojourn"], "SUP": ["ana", "kiriko", "lucio"] };
    Object.entries(heroes).forEach(([role, list]) => {
        const cat = document.createElement('div');
        cat.innerHTML = `<p style="color:var(--accent-color); font-size:12px; font-weight:bold; margin:10px 0 5px;">${role}</p><div class="hero-list" style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px;"></div>`;
        const grid = cat.querySelector('.hero-list');
        list.forEach(id => {
            const item = document.createElement('div');
            item.style.cssText = "aspect-ratio:1/1; background:#333; border-radius:4px; overflow:hidden; cursor:pointer;";
            item.innerHTML = `<img src="https://d1u1mce87gyfbn.cloudfront.net/hero/${id}/icon-portrait.png" style="width:100%">`;
            item.onclick = () => {
                const div = document.createElement('div');
                div.className = 'placed-hero';
                div.style.borderColor = currentTeamColor;
                div.style.left = ((viewport.offsetWidth/2 - tx)/scale) + 'px';
                div.style.top = ((viewport.offsetHeight/2 - ty)/scale) + 'px';
                div.innerHTML = `
                    <div class="status-badge"></div>
                    <img src="https://d1u1mce87gyfbn.cloudfront.net/hero/${id}/icon-portrait.png">
                `;
                // ê¸¸ê²Œ ëˆ„ë¥´ë©´ ê¶ê·¹ê¸° í‘œì‹œ (ëª¨ë°”ì¼ ëŒ€ì‘)
                let pressTimer;
                div.addEventListener('touchstart', () => pressTimer = setTimeout(() => toggleUlt(div), 500));
                div.addEventListener('touchend', () => clearTimeout(pressTimer));
                div.oncontextmenu = (e) => { e.preventDefault(); toggleUlt(div); };

                heroLayer.appendChild(div);
            };
            grid.appendChild(item);
        });
        document.getElementById('hero-categories').appendChild(cat);
    });

    document.getElementById('toggle-btn').onclick = () => document.getElementById('sidebar').classList.toggle('hidden');
    document.getElementById('btn-clear').onclick = () => { if(confirm('ëª¨ë‘ ì‚­ì œ?')) { ctx.clearRect(0,0,canvas.width,canvas.height); heroLayer.innerHTML=''; heroPaths.clear(); } };
</script>
</body>
</html>
